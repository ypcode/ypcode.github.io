<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>YPcode</title>
    <link rel="icon" href="/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://ypcode.github.io/posts/2019/08/spfx-scoped-context-services" />
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <meta name="generator" content="PVX WebContentGenerator" />
   
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css">
</noscript>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372458-1');
</script>

<style>
.social-links {
    display: inline-flex;
    width: 60%;
    margin:auto;
    justify-content: center;
    color: #807070;
}

.social-links a {
    margin-right: 15px;
}

.social-links a:hover {
    color: #9e1e28;
}

    .social-links svg {
        fill: currentColor;
        height: 18px;
    }
</style>
        <meta property="og:site_name" content="YPcode" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="SPFx - scoped context services" />
            <meta property="og:description" content="Let's talk about services scopes to a particular context" />
        <meta property="og:url" content="https://ypcode.github.io/posts/2019/08/spfx-scoped-context-services" />
        <meta property="og:image" content="/images/2019/08/workbench_webparts_instances.png?r=202007171112" />
        <meta property="article:publisher" content="https://www.facebook.com/yannick.plenevaux" />
        <meta property="article:published_time" content="2019-08-19 12:02:51Z" />
        <meta property="article:modified_time" content="2019-08-19 12:02:51Z" />
                <meta property="article:tag" content="JS" />
                <meta property="article:tag" content="SharePoint" />
                <meta property="article:tag" content="SharePoint Framework" />
                <meta property="article:tag" content="SPFx" />
                <meta property="article:tag" content="SPFx extensions" />
                <meta property="article:tag" content="TypeScript" />
        <meta name="twitter:title" content="SPFx - scoped context services" />
            <meta name="twitter:description" content="Let's talk about services scopes to a particular context" />
        <meta name="twitter:url" content="https://ypcode.github.io/posts/2019/08/spfx-scoped-context-services" />
            <meta name="twitter:card" content="summary_large_image" />
            <meta name="twitter:image" content="/images/2019/08/workbench_webparts_instances.png?r=202007171112" />
            <meta name="twitter:label2" content="Filed under" />
            <meta name="twitter:data2" content="JS, SharePoint, SharePoint Framework, SPFx, SPFx extensions, TypeScript" />
        <meta name="twitter:site" content="@yp_code" />
    <link rel="alternate" type="application/rss+xml" title="YPcode" href="https://ypcode.github.io/feed" />


    <script>
        var initialSiteContentHeight = null;
        function toggleMenu() {
            var menu = document.querySelector(".menu");
            var siteContent = document.querySelector(".site-content");
            if (menu && siteContent) {
                if (menu.classList.contains("visible")) {
                    menu.classList.remove("visible");
                } else {
                    menu.classList.add("visible");
                }
            }
        }
    </script>
</head>
<body>
    <div class="menu">
        <span class="menu-hamburger-icon" onclick="toggleMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" 
                x="0px" 
                y="0px"
                width="30" 
                height="30"
                viewBox="0 0 172 172"
                style=" fill:#000000;">
                    <g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M0,25.8v17.2h172v-17.2zM0,77.4v17.2h172v-17.2zM0,129v17.2h172v-17.2z"></path></g></g>
            </svg>
        </span>
        <a href="https://ypcode.github.io/">
            <h1 class="main-site-title">YPcode</h1>
            <hr class="sep main-site-title-sep"/>
            <h2 class="main-site-description">Experiences and research on Microsoft 365, Azure and modern web development</h2>
        </a>
        <nav class="navigation">
    <ul>
<li class="nav-item">
    <span class="link-icon icon-home" ></span><a class="nav-link" href="/" >Home</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/about-me/" >About me</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/projects-contrib/" >Projects &amp; Contributions</a>
</li>    </ul>
</nav>
        
            <div class="main-site-author">
                    <img class="main-site-author-picture" src="/images/me.png" />
                    <h3 class="main-site-author-name">
                        Yannick Plenevaux
                    </h3>
                        <h3 class="main-site-author-description">
                                <span class="main-site-author-description-line">Microsoft 365 Solutions Architect</span>
                                <span class="main-site-author-description-line">Office Development MVP</span>
                        </h3>
            </div>

        <div class="menu-social-links">
            <p class="social-links">

    <a href="https://mvp.microsoft.com/en-us/PublicProfile/5003599?fullName=Yannick%20Plenevaux" target="_blank"
        title="Microsoft MVP" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
            <defs>
                <style>
                    .a {
                        fill: currentColor;
                    }

                    .b {
                        fill: #1d1d1d;
                    }
                </style>
            </defs>
            <rect class="a" width="50" height="50"></rect>
            <path class="b"
                d="M17.42,26.16a15.14,15.14,0,0,0-.22,1.59l-.07.48h0a14.16,14.16,0,0,0-.33-2l-1.82-7.89h-3.5v13h2.07V24.43c0-1.18,0-2.39-.09-3.61h.08l.35,2.3,2,8.19h2.28L20,23c.18-.9.31-1.63.39-2.18h.05q-.09,2-.09,2.94v7.55h2.14v-13H19.13Zm18.36.72h1a3.81,3.81,0,0,0,3-1.24,4.54,4.54,0,0,0,1.14-3.17,4.23,4.23,0,0,0-1-3.08A3.81,3.81,0,0,0,37,18.34H33.29v13h2.49Zm0-6.37h.83a1.62,1.62,0,0,1,1.25.52,2.25,2.25,0,0,1,.48,1.57c0,1.42-.57,2.13-1.7,2.13h-.86Zm-9.24,10.8h2.67l3.31-13H30l-1.8,8.5c-.09.47-.15.92-.19,1.34l-.05.35h-.06a12,12,0,0,0-.2-1.65l-1.8-8.54H23.32ZM25.26,46.75,3.75,25.24,25.24,3.75,46.75,25.26Z"
                transform="translate(-0.25 -0.25)"></path>
        </svg>
        </a>

    <a href="https://twitter.com/yp_code" target="_blank" title="Twitter" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
            </path>
        </svg>
    </a>

    <a href="https://github.com/ypcode" target="_blank" title="GitHub" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path
                d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
            </path>
        </svg>
    </a>

    <a href="https://www.linkedin.com/in/yannickplenevaux" target="_blank" title="LinkedIn" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
                d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z">
            </path>
        </svg>
    </a>


</p>
        </div>
    </div>
   
    <div class="site-content">
        <main role="main" class="pb-3">
            <div class="content-item post">
    
    <div class="content-item-title">
        <span class="post-publishing-date">Aug 19, 2019</span>
        <h1>
            SPFx - scoped context services
            <hr/>
        </h1>
    </div>

        <div class="content-item-featured-image-container">
            <img class="content-item-featured-image" src="/images/2019/08/workbench_webparts_instances.png?r=202007171112" alt="SPFx - scoped context services" />
        </div>
   
    <div class="content">
        <p>Hi SharePoint devs,</p>
<p>In this post, I would like to share with you a pattern I like to use in my SPFx solutions and the concerns I want to address.</p>
<h1 id="spfx-services-and-servicescope">SPFx Services and ServiceScope</h1>
<p>SharePoint Framework has a service locator implementation through the ServiceScope class, it allows the IoC (Inversion of Control) in your code, that means that you delegate the creation of your service instances to a dedicated part of your code (commonly on startup) and you only consume these service instances wherever you need them, you can then centralize their initialization and configuration and avoid the need of to re-instantiate them anywhere you might need.</p>
<h2 id="why-would-it-be-a-problem">Why would it be a problem?</h2>
<p>Well, it would work to recreate the service instances every time you need them! But besides the fact that, at runtime, you will most likely consume extra memory for exact object duplicates, at design time, you will need to pass the references to all the dependencies your services might require. For instance, information from the page context will commonly be used in a SPFx solution.
If you develop your solution with a library like React, (It might be a bit different if you use Redux...) you will need to pass the references to every child component.
It means that your components would be overloaded with a ton of misc properties you could simply ignore until the very one to use them.
While I'll focus on a React sample here, the same concern applies to almost any kind of library or framework or architecture using multiple layers you might want to use.
Instead, with this approach, the only property your component will need (for that service purpose) is the ServiceScope instance !</p>
<h2 id="what-about-simply-passing-the-webpartcontextcomponentcontext-instance">What about simply passing the WebPartContext/ComponentContext instance ?</h2>
<p>One can disagree with me about that, but I really don't like this approach of passing the whole context as argument to services or as property to components for the following reasons</p>
<ol>
<li>It makes our component or units of code too dependent on the SharePoint API</li>
<li>It becomes more tricky to unit test and mock quite big object with many properties such as the WebPartContext or ComponentContext, especially when you don't have full control on.</li>
<li>It makes the required dependencies of our unit of codes too abstract, meaning that if, what we use to consume from the Context object suddenly is moved to another &quot;location&quot;, we have to refactor the interface of the services and all the calls to it</li>
<li>Whenever we need a value computed on several component-context properties, we need to rebuild it and then redo exactly the same thing, duplicates or codes, more redundant and error-prone... I'd rather do it once, and reuse it anywhere needed.</li>
</ol>
<h1 id="servicescope-root-scope-and-child-scopes">ServiceScope: root Scope and child scopes</h1>
<p>A few months ago, I posted an <a href="/posts/2019/01/25/spfx-webpart-scoped-service/">article</a> explaining the availability of root scopes and child scopes in SPFx solutions, The root scope is the default instance existing by default at scopes the whole page and has the reference to various built-in services.
In SPFx, when you declare a service (e.g. create a service key), it gets instantiated in the root scope by default. It is a reason why any SPFx service should have a default implementation. You can override these default instances in child scopes.</p>
<h2 id="child-parent-scopes">Child / Parent Scopes</h2>
<p>Child scopes are actually &quot;inheriting&quot; everything from their parent and also have their own overridden specifics. That means that all services we don't specifically override will be the instances from the parent scope. So far, I've not seen any relevant case for having 2 levels of child scopes, but, it should work... In practice, in my solutions, the parent scope have always been the root scope !</p>
<h2 id="consume-services-from-services">Consume services from services</h2>
<p>In order to keep your code maintainable and testable, ideally, you should implement your services in a way that that they are responsible only for their own relatively small and generic tasks.
It probably requires a bit more work and structure in the first place, but you will be grateful to yourself and your team whenever you have to debug it or modify it later because a single block is not doing a big amount of various unrelated actions.
That way, the services you'll use in your client code will most likely be built on several lower-level tasks wired up together and can then focus only on what it is responsible for.
An SPFx service instance always receives the reference to its service scope in its constructor.
Every service can then consume any other service available in the same scope! All that said, let's now talk about the real focus of this post.</p>
<h1 id="page-scoped-and-component-scoped-contexts">Page-scoped and Component-scoped contexts</h1>
<p>Indeed, some of the context information belongs to the page globally:</p>
<ul>
<li>The current URL</li>
<li>The current user</li>
<li>...</li>
</ul>
<p>Some other &quot;context&quot; information belongs to the component (WebPart or Extension)</p>
<ul>
<li>Instance Id</li>
<li>Component properties</li>
<li>...</li>
</ul>
<p>One way or another you would need to pass these kind of information in order to implement properly some features (Calling REST API, make some grouping, filtering,...).
If you define these as arguments to your service method, your code will become more complex to maintain because every method have then a lot of arguments, then you need to pass along making sure there is no mistake in every calls! Moreover, that will make your code much less readable...
A solution to that can be to wrap all our required dependencies in dedicated service instances we will consume. 
That will help avoid spreading the same values all over our solution as arguments to almost all methods !</p>
<h2 id="enough-muggle-language-i-want-some-code">Enough Muggle language ! I want some code !</h2>
<p>Let's remember we'll need to take care of the scope, any service instance that will hold component specific should be created in a child scope whilst the more generic or global services can be defined in the root scope.
Here is an example of 4 small services I will use in a WebPart built with React</p>
<ol>
<li><strong>PageContextService</strong> - responsible for holding all the required properties relevant for the whole page</li>
<li><strong>ComponentContextService</strong> - responsible for holding all the required properties relevant for the current component ONLY</li>
<li><strong>ListsService</strong> - responsible for fetching generic information from SharePoint lists and libraries</li>
<li><strong>DocumentsService</strong> - responsible for fetching my business specific information (for this example, it will be nothing more than the count of documents of a library)</li>
</ol>
<p> </p>
<h3 id="pagecontextservice">PageContextService</h3>
<p>This service has a configure() method that should be called at startup of the component, the other are only the properties from the page context we want to &quot;expose&quot;.
This service is global to the page, so it can remain located in the root scope and we will ensure that it is configured properly.</p>
<pre><code class="language-typescript">import { BaseComponentContext } from &quot;@microsoft/sp-component-base&quot;;
import { ServiceKey, ServiceScope } from &quot;@microsoft/sp-core-library&quot;;

export interface IPageContextService {
    configure(spfxComponentContext: BaseComponentContext): void;
    webAbsoluteUrl: string;
    // TODO Expose any needed page scoped property
    // NOTE Avoid simply exposing the whole page context
    // Exposing only the needed information in that service allows to have better control
    // and better understanding of what's really page specific or not
    // It also mitigates risk of unexpected behavior in OTB API
}

export class PageContextService implements IPageContextService {

    private _webAbsoluteUrl: string;
    private _configured: boolean = false;

    constructor(private serviceScope: ServiceScope) {

    }

    public configure(spfxComponentContext: BaseComponentContext): void {
       // Note this service should be reconfigured at each call of the configure() method
       // Because the SPA context of SharePoint might involve changes in page context

        if (!spfxComponentContext) {
            throw new Error(&quot;The SPFx component context is not specified.&quot;);
        }


        const webAbsoluteUrlFromContext = spfxComponentContext.pageContext &amp;&amp; spfxComponentContext.pageContext.web &amp;&amp; spfxComponentContext.pageContext.web.absoluteUrl;
        if (webAbsoluteUrlFromContext &amp;&amp; webAbsoluteUrlFromContext != this._webAbsoluteUrl) {
            this._webAbsoluteUrl = webAbsoluteUrlFromContext;
        }

        this._configured = (this._webAbsoluteUrl &amp;&amp; true) || false;
    }

    public get webAbsoluteUrl(): string {
        if (!this._configured) {
            throw new Error(&quot;The Page Context Service has not been properly configured.&quot;);
        }

        return this._webAbsoluteUrl;
    }
}

export const PageContextServiceKey = ServiceKey.create&lt;IPageContextService&gt;(&quot;ypcode::PageContextService&quot;, PageContextService);
</code></pre>
<h3 id="componentcontextservice">ComponentContextService</h3>
<p>As the previous, this service has a configure() method that should be called at startup of the component, the other are only the properties specific to the component instance we want to &quot;expose&quot;, it includes here the instance Id as well as the WebPart properties (we also could have mapped each single property to only expose the one we want). Notice in the configure() method I set a watch guard to avoid that the current instance of the service is configured more than once by mistake, that will ensure that we use a component-specific instance from the child scope.</p>
<pre><code class="language-typescript">import { BaseComponentContext } from &quot;@microsoft/sp-component-base&quot;;
import { ServiceKey, ServiceScope } from &quot;@microsoft/sp-core-library&quot;;
import { ISpContextServiceLabWebPartProps } from &quot;../webparts/spContextServiceLab/SpContextServiceLabWebPart&quot;;

export interface IComponentContextService {
    configure(spfxComponentContext: BaseComponentContext, properties: ISpContextServiceLabWebPartProps,force?:boolean): void;
    instanceId: string;
    properties: ISpContextServiceLabWebPartProps;
    // TODO Expose any needed component specific property
    // NOTE Avoid simply exposing the whole WebPart/Component context
    // Exposing only the needed information in that service allows to have better control
    // and better understanding of what's really component specific or not
    // It also mitigates risk of unexpected behavior in OTB API
}

export class ComponentContextService implements IComponentContextService {

    private _instanceId: string = null;
    private _properties: ISpContextServiceLabWebPartProps = null;
    private _configured: boolean = false;

    constructor(private serviceScope: ServiceScope) { }

    public configure(spfxComponentContext: BaseComponentContext, properties: ISpContextServiceLabWebPartProps, force:boolean=false): void {

        if (this._configured &amp;&amp; !force) {
            throw new Error(&quot;The ComponentContext Service has already been configured. Please review the configure() call&quot;);
        }

        this._instanceId = (spfxComponentContext &amp;&amp; spfxComponentContext.instanceId) || null;
        this._properties = properties;
        this._configured = (this._instanceId &amp;&amp; this._properties &amp;&amp; true) || false;
    }

    public get instanceId(): string {
        if (!this._configured) {
            throw new Error(&quot;The Component Context Service has not been properly configured.&quot;);
        }

        return this._instanceId;
    }

    public get properties(): ISpContextServiceLabWebPartProps {
        if (!this._configured) {
            throw new Error(&quot;The Component Context Service has not been properly initialized.&quot;);
        }

        return this._properties;
    }
}

export const ComponentContextServiceKey = ServiceKey.create&lt;IComponentContextService&gt;(&quot;ypcode::ComponentContextService&quot;, ComponentContextService);
</code></pre>
<h3 id="listsservice">ListsService</h3>
<p>This one is a generic service for fetching SharePoint list information, we can leave it at the root scope.</p>
<pre><code class="language-typescript">import { IList } from &quot;../models/IList&quot;;
import { ServiceScope, ServiceKey } from &quot;@microsoft/sp-core-library&quot;;
import { ComponentContextServiceKey } from &quot;./ComponentContextService&quot;;
import { SPHttpClient } from &quot;@microsoft/sp-http&quot;;
import { PageContextServiceKey } from &quot;./PageContextService&quot;;

export interface IListService {
    getListByTitle(listTitle: string): Promise&lt;IList&gt;;
}

export class ListService implements IListService {

    constructor(private serviceScope: ServiceScope) {
    }

    public getListByTitle(listTitle: string): Promise&lt;IList&gt; {

        return new Promise&lt;IList&gt;((resolve, reject) =&gt; {
            // Ensure the service scope is completely configured before we can consume any service
            this.serviceScope.whenFinished(() =&gt; {
                const pageContext = this.serviceScope.consume(PageContextServiceKey);
                const spHttpClient = this.serviceScope.consume(SPHttpClient.serviceKey);
                const url = `${pageContext.webAbsoluteUrl}/_api/web/lists/getbytitle('${escape(listTitle)}')`;
                spHttpClient.get(url, SPHttpClient.configurations.v1)
                    .then(r =&gt; r.json())
                    .then(l =&gt; {
                        resolve({
                            id: l.Id,
                            title: l.Title,
                            itemsCount: l.ItemCount
                        } as IList);
                    });
            });
        });
    }
}

export const ListServiceKey = ServiceKey.create&lt;IListService&gt;(&quot;ypcode::ListService&quot;, ListService);
</code></pre>
<h3 id="documentsservice">DocumentsService</h3>
<p>This service will be responsible for what we want to display in our WebPart, since it is dependent on the component specific service, we will need to provide a specific instance of it in the child scope.</p>
<pre><code class="language-typescript">import { ServiceKey, ServiceScope } from &quot;@microsoft/sp-core-library&quot;;
import { ListServiceKey } from &quot;./ListsService&quot;;
import { ComponentContextServiceKey } from &quot;./ComponentContextService&quot;;
import { WebPartContext } from &quot;@microsoft/sp-webpart-base&quot;;

export interface IDocumentsService {
    getDocumentsCount(): Promise&lt;number&gt;;
}

export class DocumentsService implements IDocumentsService {
    constructor(private serviceScope: ServiceScope) { }

    public getDocumentsCount(): Promise&lt;number&gt; {
        return new Promise&lt;number&gt;((resolve, reject) =&gt; {

            // Ensure the service scope is completely configured before we can consume any service
            this.serviceScope.whenFinished(() =&gt; {
                const listService = this.serviceScope.consume(ListServiceKey);
                const componentContextService = this.serviceScope.consume(ComponentContextServiceKey);
                const docLibName = componentContextService.properties.documentLibraryName;
                listService.getListByTitle(docLibName).then(list =&gt; {
                    resolve(list.itemsCount);
                });
            });
        });
    }


}

export const DocumentsServiceKey = ServiceKey.create&lt;IDocumentsService&gt;(&quot;ypcode::DocumentsService&quot;, DocumentsService);
</code></pre>
<p>Let's make sure we configure all this properly, I use to create some AppStartup class or even simple configure() method, under <strong>src/</strong> , in a <strong>startup/</strong> folder I created here a <strong>configure.ts</strong> file</p>
<pre><code class="language-typescript">import { ServiceScope } from &quot;@microsoft/sp-core-library&quot;;
import { BaseComponentContext } from &quot;@microsoft/sp-component-base&quot;;
import { ComponentContextServiceKey, ComponentContextService } from &quot;../services/ComponentContextService&quot;;
import { DocumentsServiceKey, DocumentsService } from &quot;../services/DocumentsService&quot;;
import { PageContextServiceKey } from &quot;../services/PageContextService&quot;;
import { ISpContextServiceLabWebPartProps } from &quot;../webparts/spContextServiceLab/SpContextServiceLabWebPart&quot;;

export const configure = (componentContext: BaseComponentContext, properties: ISpContextServiceLabWebPartProps): Promise&lt;ServiceScope&gt; =&gt; {
    const rootScope = componentContext.serviceScope;

    return new Promise((resolve, reject) =&gt; {
        try {
            // The default implementation of all services (built-in AND custom) are available at root scope
            // We should be extremely cautious of altering a root-scoped service 'state' from a specific component instance
            // This might be not that important in the context of an app-part page        
            // All services directly usable from root scope should not have any component-specific dependencies
            const pageContextService = rootScope.consume(PageContextServiceKey);
            pageContextService.configure(componentContext);

            const scopedService = rootScope.startNewChild();
            // TODO Here create and initialize the component scoped custom service instances
            // TODO Initialize and configure scoped services based on component configuration

            // The component-scoped context should be created here to ensure it will remain tied to the proper instance
            const componentContextService = scopedService.createAndProvide(ComponentContextServiceKey, ComponentContextService);
            componentContextService.configure(componentContext, properties);

            // Create and provide new instances of services that uses component specific context (configuration, instance id, ...)
            // (e.g. In this example the Documents service relies of the component configuration)
            scopedService.createAndProvide(DocumentsServiceKey, DocumentsService);

            // Finish the child scope initalization
            scopedService.finish();

            resolve(scopedService);

        } catch (error) {
            reject(error);
        }
    });
};
</code></pre>
<p>I'll let you read the comments in this code exhibit above to understand what we do.
The idea is that we always create a child scope that will pertain to the component instance, all the services from the root scope will be accessible from it anyway.
The &quot;tricky&quot; part is that all the services that depends on the component specific services should be instantiated in that new child scope.
That is probably not the best since, some of them can be generic enough that they actually don't need to be duplicated, but since they are created with the service scope, it seems to be the only way.
This configure() method has then to be called in the init event of the component (the WebPart) class, and a reference to the newly created child service scope should be kept.
This child scope reference can then be passed as property to the React component we use as you can see in the render() method.</p>
<pre><code class="language-typescript">import * as React from 'react';
import * as ReactDom from 'react-dom';
import { Version, ServiceScope } from '@microsoft/sp-core-library';
import { BaseClientSideWebPart } from '@microsoft/sp-webpart-base';
import {
  IPropertyPaneConfiguration,
  PropertyPaneTextField
} from '@microsoft/sp-property-pane';

import { FirstLevelSubComponent, IComponentProps } from './components/componentsHierarchy';
import { configure } from '../../startup/configure';
import { ComponentContextServiceKey } from '../../services/ComponentContextService';

export interface ISpContextServiceLabWebPartProps {
  documentLibraryName: string;
}

export default class SpContextServiceLabWebPart extends BaseClientSideWebPart&lt;ISpContextServiceLabWebPartProps&gt; {

  private componentServiceScope: ServiceScope;

  public onInit(): Promise&lt;void&gt; {
    // Make sure to return a resolved promise when configuration is done
    // This will ensure all services are properly configured so we can safely call serviceScope.consume() in any component 
    return configure(this.context, this.properties)
      .then(serviceScope =&gt; {
        this.componentServiceScope = serviceScope;
      }).catch(error =&gt; {
        console.error('An error occured while trying to initialize WebPart', error);
      });
  }

  public render(): void {
    const element: React.ReactElement&lt;IComponentProps&gt; = React.createElement(
      FirstLevelSubComponent,
      {
        serviceScope: this.componentServiceScope
      }
    );

    ReactDom.render(element, this.domElement);
  }

  public onPropertyPaneFieldChanged(property: string, oldValue: any, newValue: any) {
    // Update the value from configuration when changed
    const componentContextService = this.componentServiceScope.consume(ComponentContextServiceKey);
    componentContextService.properties[property] = newValue;
    this.render();
  }

  protected onDispose(): void {
    ReactDom.unmountComponentAtNode(this.domElement);
  }

  protected get dataVersion(): Version {
    return Version.parse('1.0');
  }

  protected getPropertyPaneConfiguration(): IPropertyPaneConfiguration {
    return {
      pages: [
        {
          header: {
            description: &quot;Settings&quot;
          },
          groups: [
            {
              groupName: &quot;Configuration&quot;,
              groupFields: [
                PropertyPaneTextField('documentLibraryName', {
                  label: &quot;Name of the Documents library&quot;
                }),
              ]
            }
          ]
        }
      ]
    };
  }
}
</code></pre>
<p>Let's check out what it looks like with a &quot;deep&quot; hierarchy of components</p>
<pre><code class="language-typescript">import * as React from &quot;react&quot;;
import { ServiceScope } from &quot;@microsoft/sp-core-library&quot;;
import { ListServiceKey } from &quot;../../../services/ListsService&quot;;
import { IList } from &quot;../../../models/IList&quot;;
import { DocumentsServiceKey } from &quot;../../../services/DocumentsService&quot;;
import { ComponentContextServiceKey } from &quot;../../../services/ComponentContextService&quot;;
import styles from &quot;./component.module.scss&quot;;

export interface IComponentProps {
    serviceScope: ServiceScope;
}


export class FourthLevelSubComponent extends React.Component&lt;IComponentProps, any&gt; {

    constructor(props: IComponentProps) {
        super(props);

        this.state = {
            listInfo: null as IList,
            documentsCount: null,
        };
    }

    private get instanceId(): string {
        return this.props.serviceScope.consume(ComponentContextServiceKey).instanceId;
    }

    public componentWillMount() {

        const listService = this.props.serviceScope.consume(ListServiceKey);
        const componentContext = this.props.serviceScope.consume(ComponentContextServiceKey);

        listService.getListByTitle(componentContext.properties.documentLibraryName)
            .then(docLib =&gt; {
                this.setState({
                    listInfo: docLib
                });
            }).catch(error =&gt; {
                console.log(&quot;Error: &quot;, error);
            });
    }

    private _getDocumentsCount() {
        const documentsService = this.props.serviceScope.consume(DocumentsServiceKey);
        documentsService.getDocumentsCount()
            .then(itemsCount =&gt; {
                this.setState({
                    documentsCount: itemsCount
                });
            });
    }

    public render() {
        if (!this.state.listInfo) {
            return &lt;div&gt;Loading...&lt;/div&gt;;
        }

        return &lt;div className={styles.component}&gt;
            &lt;div className={styles.title}&gt;
                WebPart: 
                &lt;span className={styles.instanceIdFromService}&gt;
                    {this.instanceId}
                &lt;/span&gt;
            &lt;/div&gt;
            &lt;br /&gt;
            &lt;br /&gt;
            &lt;h3&gt;Loaded list&lt;/h3&gt;
            ID: {this.state.listInfo.id}&lt;br /&gt;Title: {this.state.listInfo.title}
            &lt;br /&gt;&lt;br /&gt;
            &lt;button onClick={() =&gt; this._getDocumentsCount()}&gt;Get count of documents&lt;/button&gt;
            &lt;br /&gt;
            {(this.state.documentsCount || this.state.documentsCount == 0) &amp;&amp; &lt;div&gt;Count: {this.state.documentsCount}&lt;/div&gt;}
        &lt;/div&gt;;
    }
}

export class ThirdLevelSubComponent extends React.Component&lt;IComponentProps, any&gt; {
    public render() {
        return &lt;FourthLevelSubComponent serviceScope={this.props.serviceScope} /&gt;;
    }
}


export class SecondLevelSubComponent extends React.Component&lt;IComponentProps, any&gt; {
    public render() {
        return &lt;ThirdLevelSubComponent serviceScope={this.props.serviceScope} /&gt;;
    }

}


export class FirstLevelSubComponent extends React.Component&lt;IComponentProps, any&gt; {
    public render() {
        return &lt;SecondLevelSubComponent serviceScope={this.props.serviceScope} /&gt;;
    }
}
</code></pre>
<p>As you can see, the only component property we need to pass all the way down to the fourth level component is the service scope.
And even if the output itself is not much relevant without a look at the code, here is what it should display: <img src="/images/2019/08/workbench_webparts_instances.png" alt="workbench_webparts_instances" /></p>
<p>Each WebPart gets its own information from services.
You can get the whole sample solution <a href="https://github.com/ypcode/ypcode-spfx-samples/tree/master/spfx-context-services">here</a></p>
<h1 id="conclusion">Conclusion</h1>
<p>According to me, it makes everything more clear and maintainable to use only services like this.
And I would prefer the services to be the only way of using all APIs in SPFx, that would make if much more consistent instead of having of context object and a properties object, and a HttpClient you can get a reference from the context etc, etc... <strong>Let's make it all services !!</strong></p>
<p>But hey, that approach described here, I think would help to have a better structure for maintainable solutions!
What do you think??</p>
<p>Please give your feed back on Twitter or here under in the comments!</p>
<p>Cheers,</p>
<p>Yannick</p>

    </div>
</div>
        </main>

        <footer class="border-top footer">
                &copy; Copyrights 2020 - YPcode - Yannick Plenevaux
        </footer>
    </div>


    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/site.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js" ></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.js" ></script>

        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-aspnet.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-c.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-clike.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-csharp.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-css-extras.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-scss.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-markup.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-javascript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-jsx.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-powershell.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-typescript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.js" ></script>



</body>
</html>
