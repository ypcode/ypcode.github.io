<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>YPcode</title>
    <link rel="icon" href="/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://ypcode.github.io/posts/2017/10/call-protected-api-spfx" />
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <meta name="generator" content="PVX WebContentGenerator" />
   
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css">
</noscript>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372458-1');
</script>

<style>
.social-links {
    display: inline-flex;
    width: 60%;
    margin:auto;
    justify-content: center;
    color: #807070;
}

.social-links a {
    margin-right: 15px;
}

.social-links a:hover {
    color: #9e1e28;
}

    .social-links svg {
        fill: currentColor;
        height: 18px;
    }
</style>
        <meta property="og:site_name" content="YPcode" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="Call your protected API from SPFx solutions" />
        <meta property="og:url" content="https://ypcode.github.io/posts/2017/10/call-protected-api-spfx" />
        <meta property="og:image" content="https://ypcode.github.io/images/code.jpg?r=202007151015" />
        <meta property="article:publisher" content="https://www.facebook.com/yannick.plenevaux" />
        <meta property="article:published_time" content="2017-10-23 05:00:37Z" />
        <meta property="article:modified_time" content="2017-10-23 05:00:37Z" />
                <meta property="article:tag" content="Office 365" />
                <meta property="article:tag" content="PowerShell" />
                <meta property="article:tag" content="SharePoint" />
                <meta property="article:tag" content="SharePoint Framework" />
                <meta property="article:tag" content="SharePoint Online" />
                <meta property="article:tag" content="SPFx" />
                <meta property="article:tag" content="Tenant" />
                <meta property="article:tag" content="Web Development" />
        <meta name="twitter:title" content="Call your protected API from SPFx solutions" />
        <meta name="twitter:url" content="https://ypcode.github.io/posts/2017/10/call-protected-api-spfx" />
            <meta name="twitter:card" content="summary_large_image" />
            <meta name="twitter:image" content="https://ypcode.github.io/images/code.jpg?r=202007151015" />
            <meta name="twitter:label2" content="Filed under" />
            <meta name="twitter:data2" content="Office 365, PowerShell, SharePoint, SharePoint Framework, SharePoint Online, SPFx, Tenant, Web Development" />
        <meta name="twitter:site" content="@yp_code" />
    <link rel="alternate" type="application/rss+xml" title="YPcode" href="https://ypcode.github.io/feed" />


    <script>
        var initialSiteContentHeight = null;
        function toggleMenu() {
            var menu = document.querySelector(".menu");
            var siteContent = document.querySelector(".site-content");
            if (menu && siteContent) {
                if (menu.classList.contains("visible")) {
                    menu.classList.remove("visible");
                } else {
                    menu.classList.add("visible");
                }
            }
        }
    </script>
</head>
<body>
    <div class="menu">
        <span class="menu-hamburger-icon" onclick="toggleMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" 
                x="0px" 
                y="0px"
                width="30" 
                height="30"
                viewBox="0 0 172 172"
                style=" fill:#000000;">
                    <g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M0,25.8v17.2h172v-17.2zM0,77.4v17.2h172v-17.2zM0,129v17.2h172v-17.2z"></path></g></g>
            </svg>
        </span>
        <a href="https://ypcode.github.io/">
            <h1 class="main-site-title">YPcode</h1>
            <hr class="sep main-site-title-sep"/>
            <h2 class="main-site-description">Experiences and research on Microsoft 365, Azure and modern web development</h2>
        </a>
        <nav class="navigation">
    <ul>
<li class="nav-item">
    <span class="link-icon icon-home" ></span><a class="nav-link" href="/" >Home</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/about-me/" >About me</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/projects-contrib/" >Projects &amp; Contributions</a>
</li>    </ul>
</nav>
        
            <div class="main-site-author">
                    <img class="main-site-author-picture" src="/images/me.png" />
                    <h3 class="main-site-author-name">
                        Yannick Plenevaux
                    </h3>
                        <h3 class="main-site-author-description">
                                <span class="main-site-author-description-line">Microsoft 365 Solutions Architect</span>
                                <span class="main-site-author-description-line">Office Development MVP</span>
                        </h3>
            </div>

        <div class="menu-social-links">
            <p class="social-links">

    <a href="https://mvp.microsoft.com/en-us/PublicProfile/5003599?fullName=Yannick%20Plenevaux" target="_blank"
        title="Microsoft MVP" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
            <defs>
                <style>
                    .a {
                        fill: currentColor;
                    }

                    .b {
                        fill: #1d1d1d;
                    }
                </style>
            </defs>
            <rect class="a" width="50" height="50"></rect>
            <path class="b"
                d="M17.42,26.16a15.14,15.14,0,0,0-.22,1.59l-.07.48h0a14.16,14.16,0,0,0-.33-2l-1.82-7.89h-3.5v13h2.07V24.43c0-1.18,0-2.39-.09-3.61h.08l.35,2.3,2,8.19h2.28L20,23c.18-.9.31-1.63.39-2.18h.05q-.09,2-.09,2.94v7.55h2.14v-13H19.13Zm18.36.72h1a3.81,3.81,0,0,0,3-1.24,4.54,4.54,0,0,0,1.14-3.17,4.23,4.23,0,0,0-1-3.08A3.81,3.81,0,0,0,37,18.34H33.29v13h2.49Zm0-6.37h.83a1.62,1.62,0,0,1,1.25.52,2.25,2.25,0,0,1,.48,1.57c0,1.42-.57,2.13-1.7,2.13h-.86Zm-9.24,10.8h2.67l3.31-13H30l-1.8,8.5c-.09.47-.15.92-.19,1.34l-.05.35h-.06a12,12,0,0,0-.2-1.65l-1.8-8.54H23.32ZM25.26,46.75,3.75,25.24,25.24,3.75,46.75,25.26Z"
                transform="translate(-0.25 -0.25)"></path>
        </svg>
        </a>

    <a href="https://twitter.com/yp_code" target="_blank" title="Twitter" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
            </path>
        </svg>
    </a>

    <a href="https://github.com/ypcode" target="_blank" title="GitHub" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path
                d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
            </path>
        </svg>
    </a>

    <a href="https://www.linkedin.com/in/yannickplenevaux" target="_blank" title="LinkedIn" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
                d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z">
            </path>
        </svg>
    </a>


</p>
        </div>
    </div>
   
    <div class="site-content">
        <main role="main" class="pb-3">
            <div class="content-item post">
    
    <div class="content-item-title">
        <span class="post-publishing-date">Oct 23, 2017</span>
        <h1>
            Call your protected API from SPFx solutions
            <hr/>
        </h1>
    </div>

        <div class="content-item-featured-image-container">
            <img class="content-item-featured-image" src="https://ypcode.github.io/images/code.jpg?r=202007151015" alt="code image" />
        </div>
   
    <div class="content">
        <p>Hi devs, While the SharePoint Framework (aka SPFx) is getting more and more features, it becomes very handy to build engaging UI in the SharePoint context, at the Micro-services Era, it would be nice to let our solutions calling our various sets of APIs from various origins. We already have a large set of capabilities with the Microsoft Graph but we might also need to call API's outside of the Office 365 ecosystem (Line-of-Business or third parties...). Obviously, if the API processes sensitive data, it has to have at least a basic authorization mechasnism. In this post, I will show how we can achieve this using Azure Functions. If your Azure functions are contained in your tenant underlying Azure AD, there are some tricks that can be used to authenticate the current Office 365 user. (I blogged in the past about it <a href="https://ypcode.wordpress.com/2017/06/29/leverage-app-only-features-with-spfx-pnp-and-azure-functions/">here</a>). If, instead, they are in an external Azure AD, or even if it is an API hosted on a totally different platform, we can use access keys in the tenant. The technique explained below will help you do that.</p>
<h2 id="our-protected-api">Our protected API</h2>
<p>As I said above, we will use an Azure Function to simulate a protected API, but it can be any kind of API on any kind of platform. It will just be really easy to provision an new Azure Function with just a few clicks. Once logged in the Azure Portal, if you don't already have one, create a new Azure Functions app. <img src="/images/2017/10/search-function-apps.png" alt="search-function-apps" /> <img src="/images/2017/10/new-azure-function1.png" alt="new-azure-function.png" />   There is a requirement the API should meet to be called from your SPFx solution, it must allow Cross Origin Resource Sharing (CORS), If you use a public API, it will most likely satisfy this condition. In the case of our Azure Function, we have to tweak a dedicated setting. Switch to the <em><strong>Platform Features</strong></em> tab and select the <em><strong>CORS</strong></em> item. <img src="/images/2017/10/platform-features-tab.png" alt="platform-features-tab" /> <img src="/images/2017/10/cors_link.png" alt="CORS_link.png" /> In the <em>Allowed Origins</em>, remove the default values and add &quot;*<strong>&quot;</strong>, you can also choose to allow only certain domains. <img src="/images/2017/10/cors_all.png" alt="CORS_ALL.png" /> Now that we have set the needed configuration for our Function App, we can add our function. Add a new <em><strong>HttpTrigger</strong></em> in your preferred language, in this case I chose JavaScript, (IMHO, it is easier to work with SPFx, because we work directly with JSON, but remember, this API could be anything, and more than likely will not be dedicated for your SPFx solution). <img src="/images/2017/10/add-newhttptrigger-js.png" alt="add-newhttptrigger-js.png" /> I leave the sample code as it is (except for the body that I make a JSON object with a <strong>message</strong> property and append &quot;from protected API&quot; in the default message). <img src="/images/2017/10/azure-func-code.png" alt="azure-func-code" /> Click the <em><strong>Get function URL</strong></em> link in the right corner <img src="/images/2017/10/azure-func-url-link.png" alt="azure-func-url-link" /> <img src="/images/2017/10/copy-azure-func-url.png" alt="copy-azure-func-url" /> Choose the default for Key (it will be the &quot;password&quot; to access our API, then copy/paste the URL, we will need it in our code. And that's it for our API !</p>
<h2 id="our-spfx-extension">Our SPFx extension</h2>
<p>I opted here to create an simplistic SPFx Application Customizer extension that will show the message from the API in an Alert Dialog. Let's create our extension. Go for the now famous _**yo @microsoft/sharepoint. **_Answer the questions to choose a <em>SharePoint Online target environment</em>, <em>extension</em> and <em>ApplicationCustomizer</em>. In your Application Customizer code file, let's first create a constant outside of our class that will hold the API URL: <code>\nexport const API_URL = 'https://my-func.azurewebsites.net/api/myapi';\n</code> Notice that I removed the ?code= ... but let's keep its value, we will need it later. Let's change the properties interface of our customizer to be <a href="https://gist.github.com/ypcode/1132b22cf206927e43462881dc29ac42">https://gist.github.com/ypcode/1132b22cf206927e43462881dc29ac42</a> In the <em><strong>onInit()</strong></em> method of our ApplicationCustomizer class, we write the following code <a href="https://gist.github.com/ypcode/9641e38a570773dc576e1a3160b33d9d">https://gist.github.com/ypcode/9641e38a570773dc576e1a3160b33d9d</a> in the terminal, type the <em><strong>gulp serve --nobrowser</strong></em> command and go to your SharePoint Online site. in the URL append the following string:</p>
<p><em>?loadSPFX=true&amp;debugManifestsFile=https://localhost:4321/temp/manifests.js&amp;customActions={&quot;<strong>b5d0b3ee-f1dc-4c96-b1ce-d81c8b21a139</strong>&quot;:{&quot;location&quot;:&quot;ClientSideExtension.ApplicationCustomizer&quot;,&quot;properties&quot;:{&quot;apiKeyPropertyKey&quot;:&quot;SPFxTestApiKey&quot;}}}</em>  </p>
<p>Change the Id in bold by the Id you will find in your xxxx.manifest.json <img src="/images/2017/10/manifestjson.png" alt="manifestjson.png" /></p>
<p>If we try it now, we see <img src="/images/2017/10/unauthorized.png" alt="unauthorized" /></p>
<p>Indeed, you might have noticed in the code the first HTTP call we issue to the <em><strong>_api/web/GetStorageEntity</strong></em> endpoint.</p>
<p>We actually use here a recent feature in Office 365: <strong>Tenant-Scope properties</strong>. It's a location where administrators can store information that can be accessed by regular (properly logged in) users through JavaScript.</p>
<h2 id="store-the-api-access-key-in-sharepoint">Store the API Access Key in SharePoint</h2>
<p>We will use this location to store the access key to our API. To do so, we need to install the <a href="https://www.microsoft.com/en-us/download/details.aspx?id=35588">SharePoint Online Management Shell.</a> Once installed, open a PowerShell console and type the following commands.</p>
<p><code>\nConnect-SPOService https://yourtenant-admin.sharepoint.com Set-SPOStorageEntity -Site https://yourtenant.sharepoint.com/sites/appcatalog -Key SPFxTestApiKey -Value &quot;The API code&quot; -Description &quot;The key to the API&quot;  -Comments &quot;...&quot;\n</code></p>
<ul>
<li>The value of the URL argument should be the URL of your App Catalog.</li>
<li>The value of the Value argument is the code we removed from the API URL earlier.</li>
</ul>
<p>Now that we have the access key or the API stored as a tenant property, we can retry our extension. <img src="/images/2017/10/api-works.png" alt="api-works" /></p>
<h2 id="conclusion"> Conclusion</h2>
<p>Here we use the tenant properties to store the Access Key of our API. It is only one of the possibilities that Tenant properties offer. We can imagine using them to store License keys, configuration objects or any kind of information that must be available across the tenant. Moreover,  here, we do store the API access key in clear directly in the tenant property bag. We might also imagine a solution in which we'd store a kind of pre-shared key or a &quot;secret&quot; that will never go on the wire in clear but instead will be used to compute a unique hash that will be recomputed by the API to check the incoming request is not a malicious one and is issued by an expected endpoint. From a security perspective, we can implement all kind of scenarios to better protect our APIs. Hope you will find this interesting and it will help you in your SPFx journey ! Please give your feedback !</p>
<p> Yannick</p>

    </div>
</div>
        </main>

        <footer class="border-top footer">
                &copy; Copyrights 2020 - YPcode - Yannick Plenevaux
        </footer>
    </div>


    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/site.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js" ></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.js" ></script>

        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-aspnet.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-c.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-clike.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-csharp.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-css-extras.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-scss.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-markup.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-javascript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-jsx.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-powershell.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-typescript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.js" ></script>



</body>
</html>
