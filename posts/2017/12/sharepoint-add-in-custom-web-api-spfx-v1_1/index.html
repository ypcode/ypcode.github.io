<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>YPcode</title>
    <link rel="icon" href="/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://ypcode.github.io/posts/2017/12/sharepoint-add-in-custom-web-api-spfx-v1_1" />
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <meta name="generator" content="PVX WebContentGenerator" />
   
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css">
</noscript>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372458-1');
</script>

<style>
.social-links {
    display: inline-flex;
    width: 60%;
    margin:auto;
    justify-content: center;
    color: #807070;
}

.social-links a {
    margin-right: 15px;
}

.social-links a:hover {
    color: #9e1e28;
}

    .social-links svg {
        fill: currentColor;
        height: 18px;
    }
</style>
        <meta property="og:site_name" content="YPcode" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="SharePoint add-in, custom Web API and SPFx (v1.1)" />
        <meta property="og:url" content="https://ypcode.github.io/posts/2017/12/sharepoint-add-in-custom-web-api-spfx-v1_1" />
        <meta property="og:image" content="https://ypcode.github.io/images/code.jpg?r=202007151110" />
        <meta property="article:publisher" content="https://www.facebook.com/yannick.plenevaux" />
        <meta property="article:published_time" content="2017-12-29 21:44:43Z" />
        <meta property="article:modified_time" content="2017-12-29 21:44:43Z" />
                <meta property="article:tag" content="App Only" />
                <meta property="article:tag" content="App Permissions" />
                <meta property="article:tag" content="ASP.NET" />
                <meta property="article:tag" content="Document Library" />
                <meta property="article:tag" content="JavaScript" />
                <meta property="article:tag" content="JS" />
                <meta property="article:tag" content="PnP" />
                <meta property="article:tag" content="PowerShell" />
                <meta property="article:tag" content="SharePoint" />
                <meta property="article:tag" content="SharePoint Framework" />
                <meta property="article:tag" content="SharePoint Online" />
                <meta property="article:tag" content="SharePoint2016" />
                <meta property="article:tag" content="SPFx" />
                <meta property="article:tag" content="TypeScript" />
        <meta name="twitter:title" content="SharePoint add-in, custom Web API and SPFx (v1.1)" />
        <meta name="twitter:url" content="https://ypcode.github.io/posts/2017/12/sharepoint-add-in-custom-web-api-spfx-v1_1" />
            <meta name="twitter:card" content="summary_large_image" />
            <meta name="twitter:image" content="https://ypcode.github.io/images/code.jpg?r=202007151110" />
            <meta name="twitter:label2" content="Filed under" />
            <meta name="twitter:data2" content="App Only, App Permissions, ASP.NET, Document Library, JavaScript, JS, PnP, PowerShell, SharePoint, SharePoint Framework, SharePoint Online, SharePoint2016, SPFx, TypeScript" />
        <meta name="twitter:site" content="@yp_code" />
    <link rel="alternate" type="application/rss+xml" title="YPcode" href="https://ypcode.github.io/feed" />


    <script>
        var initialSiteContentHeight = null;
        function toggleMenu() {
            var menu = document.querySelector(".menu");
            var siteContent = document.querySelector(".site-content");
            if (menu && siteContent) {
                if (menu.classList.contains("visible")) {
                    menu.classList.remove("visible");
                } else {
                    menu.classList.add("visible");
                }
            }
        }
    </script>
</head>
<body>
    <div class="menu">
        <span class="menu-hamburger-icon" onclick="toggleMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" 
                x="0px" 
                y="0px"
                width="30" 
                height="30"
                viewBox="0 0 172 172"
                style=" fill:#000000;">
                    <g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M0,25.8v17.2h172v-17.2zM0,77.4v17.2h172v-17.2zM0,129v17.2h172v-17.2z"></path></g></g>
            </svg>
        </span>
        <a href="https://ypcode.github.io/">
            <h1 class="main-site-title">YPcode</h1>
            <hr class="sep main-site-title-sep"/>
            <h2 class="main-site-description">Experiences and research on Microsoft 365, Azure and modern web development</h2>
        </a>
        <nav class="navigation">
    <ul>
<li class="nav-item">
    <span class="link-icon icon-home" ></span><a class="nav-link" href="/" >Home</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/about-me/" >About me</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/projects-contrib/" >Projects &amp; Contributions</a>
</li>    </ul>
</nav>
        
            <div class="main-site-author">
                    <img class="main-site-author-picture" src="/images/me.png" />
                    <h3 class="main-site-author-name">
                        Yannick Plenevaux
                    </h3>
                        <h3 class="main-site-author-description">
                                <span class="main-site-author-description-line">Microsoft 365 Solutions Architect</span>
                                <span class="main-site-author-description-line">Office Development MVP</span>
                        </h3>
            </div>

        <div class="menu-social-links">
            <p class="social-links">

    <a href="https://mvp.microsoft.com/en-us/PublicProfile/5003599?fullName=Yannick%20Plenevaux" target="_blank"
        title="Microsoft MVP" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
            <defs>
                <style>
                    .a {
                        fill: currentColor;
                    }

                    .b {
                        fill: #1d1d1d;
                    }
                </style>
            </defs>
            <rect class="a" width="50" height="50"></rect>
            <path class="b"
                d="M17.42,26.16a15.14,15.14,0,0,0-.22,1.59l-.07.48h0a14.16,14.16,0,0,0-.33-2l-1.82-7.89h-3.5v13h2.07V24.43c0-1.18,0-2.39-.09-3.61h.08l.35,2.3,2,8.19h2.28L20,23c.18-.9.31-1.63.39-2.18h.05q-.09,2-.09,2.94v7.55h2.14v-13H19.13Zm18.36.72h1a3.81,3.81,0,0,0,3-1.24,4.54,4.54,0,0,0,1.14-3.17,4.23,4.23,0,0,0-1-3.08A3.81,3.81,0,0,0,37,18.34H33.29v13h2.49Zm0-6.37h.83a1.62,1.62,0,0,1,1.25.52,2.25,2.25,0,0,1,.48,1.57c0,1.42-.57,2.13-1.7,2.13h-.86Zm-9.24,10.8h2.67l3.31-13H30l-1.8,8.5c-.09.47-.15.92-.19,1.34l-.05.35h-.06a12,12,0,0,0-.2-1.65l-1.8-8.54H23.32ZM25.26,46.75,3.75,25.24,25.24,3.75,46.75,25.26Z"
                transform="translate(-0.25 -0.25)"></path>
        </svg>
        </a>

    <a href="https://twitter.com/yp_code" target="_blank" title="Twitter" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
            </path>
        </svg>
    </a>

    <a href="https://github.com/ypcode" target="_blank" title="GitHub" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path
                d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
            </path>
        </svg>
    </a>

    <a href="https://www.linkedin.com/in/yannickplenevaux" target="_blank" title="LinkedIn" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
                d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z">
            </path>
        </svg>
    </a>


</p>
        </div>
    </div>
   
    <div class="site-content">
        <main role="main" class="pb-3">
            <div class="content-item post">
    
    <div class="content-item-title">
        <span class="post-publishing-date">Dec 29, 2017</span>
        <h1>
            SharePoint add-in, custom Web API and SPFx (v1.1)
            <hr/>
        </h1>
    </div>

        <div class="content-item-featured-image-container">
            <img class="content-item-featured-image" src="https://ypcode.github.io/images/code.jpg?r=202007151110" alt="code image" />
        </div>
   
    <div class="content">
        <p>Hi SharePoint guys ! It's been a while I haven't written a blog post mainly due to lack of free time. Thanks to the end of year holidays, I could spend a few hours to build a proof-of-concept which, IMHO, might be really interesting. Hope you will be interested in it as much as I am.</p>
<h1 id="introduction">Introduction</h1>
<p>The SharePoint Framework is the new promoted development model for SharePoint customizations. It follows the current web development trends (Asynchronous HTTP calls, Web/REST APIs, ...). In this article, we will then see how to implement a custom Web API based on the SharePoint add-in model we can call from our SPFx solutions. A few months ago, I wrote <a href="https://ypcode.wordpress.com/2017/06/29/leverage-app-only-features-with-spfx-pnp-and-azure-functions/">a post explaning how to call App Only proxy implemented as Azure Functions from SPFx</a>. This previous blog post focuses on Azure Functions, and is relevant for Cloud or Hybrid environments, it relies on Azure Function, Azure AD and can easily be extended with Microsoft Graph. Unfortunately, in a 'pure' On-prem environment without any cloud components, the previous blog post is not relevant. At the time, SPFx was not available for SharePoint on-premises, Now it is ! I then decided to port this concept using the assets and techniques we can all use in a full on-prem environment. This post will leverage the SharePoint provider-hoster add-in model which is applicable to both SharePoint Online and SharePoint (full) On-prem.</p>
<h1 id="the-case-study">The case study</h1>
<p>In order to implement a relevant Proof-of-Concept, let's ellaborate a context and some requirements.</p>
<ul>
<li>We want to manage some business documents from a custom SPFx WebParts</li>
<li>The SPFx WebPart will interact with SharePoint exclusively via a custom Web API</li>
<li>The custom Web API will be a simple CRUD for _Business Documents_stored in a SharePoint document library</li>
</ul>
<p>To make sure to rely on the same library structure as I am, you can use the provisioning assets <a href="https://github.com/ypcode/spfx-webapi-spaddin/tree/master/Provisioning">here</a>. You will need to have the <a href="https://github.com/SharePoint/PnP-PowerShell#installation">PnP PowerShell module installed</a> and execute the <strong><em>Provision.ps1</em></strong> script.</p>
<h1 id="lets-create-a-sharepoint-add-in">Let's create a SharePoint add-in</h1>
<p>We will first create a new SharePoint provider-hosted add-in solution like any other one. Open Visual Studio and create your new project as usual <img src="/images/2017/12/vs-newproj.png" alt="vs-newproj" /> Enter the address of your SharePoint development site and select the <strong><em>Provider-hosted</em></strong> hosting option. <img src="/images/2017/12/vs-addin-type.png" alt="vs-addin-type" /> Select the targeted SharePoint version (in my case, I use SharePoint Online, but this blog post is also valid for SharePoint 2016 FP2) <img src="/images/2017/12/vs-choose-spversion.png" alt="vs-choose-spversion" /> Select <strong><em>ASP.NET MVC Web Application</em></strong> <img src="/images/2017/12/vs-choose-webapp-type.png" alt="vs-choose-webapp-type" /> <img src="/images/2017/12/vs-choose-trust-type.png" alt="vs-choose-trust-type" /></p>
<ol>
<li>Select this option if you are using SharePoint Online or SharePoint On-prem with a configured low trust</li>
<li>Select this option if you are using Server-to-server authentication in an on-prem environement (You will have to configure the X.509 certificate if you do so). <a href="https://docs.microsoft.com/en-us/sharepoint/dev/sp-add-ins/create-high-trust-sharepoint-add-ins">Check this for more accurate information</a></li>
</ol>
<p>Now that we have the boilerplate code of our solution, let's configure the SharePoint add-in. Open the AppManifest.xml file Let's change the start page value <img src="/images/2017/12/addin-appmanifest-startpage.png" alt="addin-appmanifest-startpage" /> Let's set the <strong><em>[your-project]/Home/Register</em></strong> value. On the <strong>permissions</strong> tab, select <strong>List</strong> as the Scope and select <strong>Full Control</strong>. Make sure to tick the checkbox to allow app-only calls <img src="/images/2017/12/addin-appmanifest-perms.png" alt="addin-appmanifest-perms" /></p>
<h1 id="a-custom-web-api-in-a-sharepoint-add-in">A custom Web API in a SharePoint add-in</h1>
<p>The SharePoint provider-hosted add-in model and the featured boilerplate code in the corresponding Visual Studio project template allows to use CSOM either in App+User or in App-Only mode.</p>
<h3 id="how-does-it-work">How does it work ?</h3>
<p>It relies on an authentication flow (OAuth in low-trust or direct in high-trust). To initiate this authentication flow, when you click the add-in icon in SharePoint, you reach a SharePoint system page (<strong>appredirect.aspx</strong>) that redirects you to your provider hosted application default page. This HTTP call issued for the redirection contains all the information of the current context (SharePoint and User context), this context will be persisted in the user session on the server side. It will later be used to create a CSOM ClientContext object instance that is the base of any CSOM operation. At each time a page (or ASP.NET MVC action) is reached, the current user context is fetched from his session state or created if it does not exist yet. If no context can be fetched or created on the server (for example, because needed information is missing), the user is redirected to an error page. because he cannot be properly authenticated, he won't be able to go further.</p>
<h3 id="with-a-stateless-web-api">With a stateless Web API ?</h3>
<p>By nature, a Web/REST API is stateless, it means that the common implementation will not handle user sessions. In the code, you won't have access to any session state for the current Request object. Anyway,  the SharePoint add-in model needs some kind of session mechanism to work properly, we can implement our own session mechanism with the following steps :</p>
<ol>
<li>When the <strong><em>appredirect.aspx</em></strong> SharePoint page redirects to the provider-hosted addin default page, save the created context in cache with a specific key.</li>
<li>Add a cookie in the HTTP response that will contain the cache key. This cookie will be included in all subsequent calls</li>
<li>In the next HTTP calls, get the cached context using the key contained in the cookie of the current request.</li>
</ol>
<blockquote>
<p>Hum...OK. That's a lot of work for such a basic thing...</p>
</blockquote>
<p><img src="/images/2017/12/pnp-superhero.png" alt="pnp-superhero" /> Exactly ! We might need some help! Let's call our friend the PnP super-hero ! Actually, once again, the community has done great job and already implemented such a mechanism in the PnP Core library. All the stuff we need are here: <a href="https://github.com/SharePoint/PnP-Sites-Core/tree/master/Core/OfficeDevPnP.Core/WebAPI">https://github.com/SharePoint/PnP-Sites-Core/tree/master/Core/OfficeDevPnP.Core/WebAPI</a> OK, let's install the PnP Core library package in our solution. In the <strong><em>Package Manager Console</em></strong> of Visual Studio, make sure you select your Web application project and type the following command <img src="/images/2017/12/vs-packagemanager-installpnp2016.png" alt="vs-packagemanager-installpnp2016" /> There is a module for each SharePoint currently supported version</p>
<ul>
<li>SharePointPnPCore2013</li>
<li>SharePointPnPCore2016</li>
<li>SharePointPnPCoreOnline</li>
</ul>
<p>Choose the one that suits for you. While you're in the Package Manager console, enter also the command: <strong><em>&gt; Install-Package Microsoft.AspNet.WebApi.Cors</em></strong> As you understood above, we will need to register the Web API to make sure the subsequent calls will be able to fetch the SharePoint context stored in the cache. In the HomeController, we will then create a dedicated action (make sure to include the needed using clause) <code>\nusing OfficeDevPnP.Core.WebAPI;  //...  [SharePointContextFilter] public ActionResult Register() {    try    {        // Register the BusinessDocuments API        WebAPIHelper.RegisterWebAPIService(this.HttpContext, &quot;/api/BusinessDocuments&quot;);        return Json(new { message = &quot;Web API registered&quot; });    }    catch (Exception ex)    {        return Json(ex);    } }\n</code> Let's then create a ViewModel class that will represent our business document entity. In the empty <strong>Models</strong> folder, add a new class name <strong><em>BusinessDocumentViewModel</em></strong> <a href="https://gist.github.com/ypcode/662c2ae7a4607886614f93eb979ee671">https://gist.github.com/ypcode/662c2ae7a4607886614f93eb979ee671</a> We will then add our Web API controller</p>
<ol>
<li>Right-click the <strong>Controllers</strong> folder</li>
<li>Expand the <strong>Add</strong> menu</li>
<li>Click <strong>Controller...</strong></li>
</ol>
<p><img src="/images/2017/12/vs-add-apicontroller-01.png" alt="vs-add-apicontroller-01" /> Select the Web API 2 Controller with read/write actions<img src="/images/2017/12/vs-add-apicontroller-02.png" alt="vs-add-apicontroller-02" />And name if &quot;<strong><em>BusinessDocumentsController</em></strong>&quot;<img src="/images/2017/12/vs-name-apicontroller.png" alt="vs-name-apicontroller" /> Replace the code of the scaffolded class by this one <code>\nusing Microsoft.SharePoint.Client; using OfficeDevPnP.Core.WebAPI; using spaddin_webapiWeb.Models; using System; using System.Collections.Generic; using System.Linq; using System.Net; using System.Net.Http; using System.Web.Http; using System.Web.Http.Cors;  namespace spaddin_webapiWeb.Controllers {     [EnableCors(origins: &quot;https://ypcode.sharepoint.com,https://localhost:4321&quot;,          headers: &quot;*&quot;,          methods: &quot;*&quot;,         SupportsCredentials = true)]     [WebAPIContextFilter]     public class BusinessDocumentsController : ApiController     {         public const string FileLeafRefField = &quot;FileLeafRef&quot;;         public const string InChargeField = &quot;InCharge&quot;;         public const string DocumentPurposeField = &quot;DocumentPurpose&quot;;          public static string[] ValidDocumentPurposes = new string[]         {             &quot;Agreement project&quot;,             &quot;Offer project&quot;,             &quot;Purchase project&quot;,             &quot;Research document&quot;         };                  private static BusinessDocumentViewModel ListItemToViewModel(ListItem businessDocListItem)         {             FieldUserValue inChargeUserValue = businessDocListItem[InChargeField] as FieldUserValue;             string inChargeValue = inChargeUserValue != null ? inChargeUserValue.LookupValue : string.Empty;              return new BusinessDocumentViewModel()             {                 Id = businessDocListItem.Id,                 Name = (string)businessDocListItem[FileLeafRefField],                 Purpose = (string)businessDocListItem[DocumentPurposeField],                 InCharge = inChargeValue             };         }          private static ListItem MapToListItem(BusinessDocumentViewModel viewModel, ListItem targetListItem)         {             targetListItem[FileLeafRefField] = viewModel.Name;             targetListItem[DocumentPurposeField] = viewModel.Purpose;             targetListItem[InChargeField] = FieldUserValue.FromUser(viewModel.InCharge);             return targetListItem;         }          private static ListItem TryGetListItemById(List list, int id)         {             try             {                 ListItem item = list.GetItemById(id);                 list.Context.Load(item, i =&gt; i.Id);                 list.Context.ExecuteQuery();                 return item;             }             catch (Exception)             {                 return null;             }         }          private static bool ValidateModel(BusinessDocumentViewModel viewModel, out string message)         {             // Validate the purpose is a valid value             if (!ValidDocumentPurposes.Contains(viewModel.Purpose))             {                 message = &quot;The specified document purpose is invalid&quot;;                 return false;             }              message = string.Empty;             return true;         }          // GET: api/BusinessDocuments         public IEnumerable&lt;BusinessDocumentViewModel&gt; Get()         {             using (var clientContext = WebAPIHelper.GetClientContext(this.ControllerContext))             {                 // Get the documents from the Business Documents library                 List businessDocsLib = clientContext.Web.GetListByUrl(&quot;/BusinessDocs&quot;);                 ListItemCollection businessDocItems = businessDocsLib.GetItems(CamlQuery.CreateAllItemsQuery());                  clientContext.Load(businessDocItems, items =&gt; items.Include(                     item =&gt; item.Id,                     item =&gt; item[FileLeafRefField],                     item =&gt; item[InChargeField],                     item =&gt; item[DocumentPurposeField]));                 clientContext.ExecuteQuery();                  // Create collection of view models from list item collection                 List&lt;BusinessDocumentViewModel&gt; viewModels = businessDocItems.Select(ListItemToViewModel).ToList();                  return viewModels;             }         }          // GET: api/MyBusinessDocuments         [HttpGet]         [Route(&quot;api/MyBusinessDocuments&quot;)]         public IEnumerable&lt;BusinessDocumentViewModel&gt; MyBusinessDocuments()         {             using (var clientContext = WebAPIHelper.GetClientContext(this.ControllerContext))             {                  // Get the documents from the Business Documents library                 List businessDocsLib = clientContext.Web.GetListByUrl(&quot;/BusinessDocs&quot;);                 var camlQuery = new CamlQuery                 {                     ViewXml = $@&quot;&lt;View&gt;&lt;Query&gt;&lt;Where&gt;     &lt;Eq&gt;         &lt;FieldRef Name='{InChargeField}' LookupId='TRUE' /&gt;         &lt;Value Type = 'Integer'&gt;&lt;UserID /&gt;&lt;/Value&gt;      &lt;/Eq&gt;  &lt;/Where&gt;&lt;/Query&gt;&lt;/View&gt;&quot;                 };                 ListItemCollection businessDocItems = businessDocsLib.GetItems(camlQuery);                                  clientContext.Load(businessDocItems, items =&gt; items.Include(                     item =&gt; item.Id,                     item =&gt; item[FileLeafRefField],                     item =&gt; item[InChargeField],                     item =&gt; item[DocumentPurposeField]));                 clientContext.ExecuteQuery();                  // Create collection of view models from list item collection                 List&lt;BusinessDocumentViewModel&gt; viewModels = businessDocItems.Select(ListItemToViewModel).ToList();                  return viewModels;             }         }                    // GET: api/BusinessDocuments/5         public IHttpActionResult Get(int id)         {             using (var clientContext = WebAPIHelper.GetClientContext(this.ControllerContext))             {                 // Get the documents from the Business Documents library                 List businessDocsLib = clientContext.Web.GetListByUrl(&quot;/BusinessDocs&quot;);                 ListItem businessDocItem = TryGetListItemById(businessDocsLib, id);                 if (businessDocItem == null)                     return NotFound();                  // Ensure the needed metadata are loaded                 clientContext.Load(businessDocItem, item =&gt; item.Id,                     item =&gt; item[FileLeafRefField],                     item =&gt; item[InChargeField],                     item =&gt; item[DocumentPurposeField]);                 clientContext.ExecuteQuery();                  // Create a view model object from the list item                 BusinessDocumentViewModel viewModel = ListItemToViewModel(businessDocItem);                  return Ok(viewModel);             }         }          // POST: api/BusinessDocuments         public IHttpActionResult Post([FromBody]BusinessDocumentViewModel value)         {             string validationError = null;             if (!ValidateModel(value, out validationError))             {                 return BadRequest(validationError);             }              using (var clientContext = WebAPIHelper.GetClientContext(this.ControllerContext))             {                 // Get the documents from the Business Documents library                 List businessDocsLib = clientContext.Web.GetListByUrl(&quot;/BusinessDocs&quot;);                 // Ensure the root folder is loaded                 Folder rootFolder = businessDocsLib.EnsureProperty(l =&gt; l.RootFolder);                 ListItem newItem = businessDocsLib.CreateDocument(value.Name, rootFolder, DocumentTemplateType.Word);                  // Update the new document metadata                 newItem[DocumentPurposeField] = value.Purpose;                 newItem[InChargeField] = FieldUserValue.FromUser(value.InCharge);                 newItem.Update();                  // Ensure the needed metadata are loaded                 clientContext.Load(newItem, item =&gt; item.Id,                     item =&gt; item[FileLeafRefField],                     item =&gt; item[InChargeField],                     item =&gt; item[DocumentPurposeField]);                  newItem.File.CheckIn(&quot;&quot;, CheckinType.MajorCheckIn);                 clientContext.ExecuteQuery();                  BusinessDocumentViewModel viewModel = ListItemToViewModel(newItem);                 return Created($&quot;/api/BusinessDocuments/{viewModel.Id}&quot;, viewModel);             }         }                  // PUT: api/BusinessDocuments/5         public IHttpActionResult Put(int id, [FromBody]BusinessDocumentViewModel value)         {             string validationError = null;             if (!ValidateModel(value, out validationError))             {                 return BadRequest(validationError);             }              using (var clientContext = WebAPIHelper.GetClientContext(this.ControllerContext))             {                 // Get the documents from the Business Documents library                 List businessDocsLib = clientContext.Web.GetListByUrl(&quot;/BusinessDocs&quot;);                 ListItem businessDocItem = TryGetListItemById(businessDocsLib, id);                  // If not found, return the appropriate status code                 if (businessDocItem == null)                     return NotFound();                  // Update the list item properties                 MapToListItem(value, businessDocItem);                 businessDocItem.Update();                 clientContext.ExecuteQuery();                  return Ok();             }         }          // DELETE: api/BusinessDocuments/5         public IHttpActionResult Delete(int id)         {             using (var clientContext = WebAPIHelper.GetClientContext(this.ControllerContext))             {                 // Get the document from the Business Documents library                 List businessDocsLib = clientContext.Web.GetListByUrl(&quot;/BusinessDocs&quot;);                 ListItem businessDocItem = TryGetListItemById(businessDocsLib, id);                 // If not found, return the appropriate status code                 if (businessDocItem == null)                     return NotFound();                  // Delete the list item                 businessDocItem.DeleteObject();                 clientContext.ExecuteQuery();                  return Ok();             }         }     } }\n</code> It is the complete implementation of our custom Web API. We have to notice several important parts:</p>
<ol>
<li>The use of [<strong><em>EnableCors</em></strong>] attribute that will allow our Web API to be called from JavaScript executed outside of our domain (JavaScript of the SPFx WebPart. You will have to change the value of the <strong><em>origins</em></strong> parameter to match your own SharePoint domain.</li>
<li>The use of [<strong><em>WebAPIContextFilter</em></strong>] attribute that will make sure the call is issued by an authenticated user. Will actually fetch the context in cache from the key stored in the request cookie.</li>
<li>The use of <strong><em>varclientContext = WebAPIHelper.GetClientContext(this.ControllerContext)</em></strong> instead of the classic **<em>SharePointContextProvider</em>**to instantiate the ClientContext object.</li>
</ol>
<p>In order for everything to work, you will also have to make some changes in the <strong><em>Global.asax</em></strong> file <code>\nusing System; using System.Collections.Generic; using System.Linq; using System.Web; using System.Web.Http; using System.Web.Mvc; using System.Web.Optimization; using System.Web.Routing;  namespace spaddin_webapiWeb {     public class MvcApplication : System.Web.HttpApplication     {         protected void Application_Start()         {             AreaRegistration.RegisterAllAreas();             FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);             // Make sure to include this before the RouteConfig.RegisterRoutes() call             GlobalConfiguration.Configure(WebApiConfig.Register);             RouteConfig.RegisterRoutes(RouteTable.Routes);             BundleConfig.RegisterBundles(BundleTable.Bundles);         }     } }\n</code> as well as in the <strong>WebApiConfig</strong> class <a href="https://gist.github.com/ypcode/ea51f85157363d4bfa4333b687fa8d9b">https://gist.github.com/ypcode/ea51f85157363d4bfa4333b687fa8d9b</a> At this step, we are done with our Web API. you can hit <strong>F5</strong> to deploy the addin of our dev site. You can leave it running. Don't forget to select the right library when trusting the add-in <img src="/images/2017/12/trust-webapi.png" alt="trust-webapi" /> If you want to see the complete Web API solution code, you can go to the <a href="https://github.com/ypcode/spfx-webapi-spaddin/tree/master/spaddin-webapi">GitHub repo</a></p>
<h1 id="the-spfx-webpart">The SPFx WebPart</h1>
<p>Let's create a new SPFx WebPart project with the famous <strong><em>yo @microsoft/sharepoint</em></strong> Let's add a service class that will be responsible to issue the calls the our Web API <code>\nimport { IApiConfigService, ApiConfigServiceKey } from './ApiConfigService'; import HttpClient from '@microsoft/sp-http/lib/httpClient/HttpClient'; import { IBusinessDocument } from '../entities/IBusinessDocument'; import { ServiceScope, ServiceKey } from '@microsoft/sp-core-library';  export interface IBusinessDocumentsService { 	getAllBusinessDocuments(): Promise&lt;IBusinessDocument[]&gt;; 	getMyBusinessDocuments(): Promise&lt;IBusinessDocument[]&gt;; 	getBusinessDocument(id: number): Promise&lt;IBusinessDocument&gt;; 	createBusinessDocument(businessDocument: IBusinessDocument): Promise&lt;any&gt;; 	updateBusinessDocument(id: number, update: IBusinessDocument): Promise&lt;any&gt;; 	removeBusinessDocument(id: number): Promise&lt;any&gt;; }  export class BusinessDocumentsService implements IBusinessDocumentsService {   private httpClient: HttpClient;   private apiConfig: IApiConfigService;   	constructor(private serviceScope: ServiceScope) { 		serviceScope.whenFinished(() =&gt; {       this.httpClient = serviceScope.consume(HttpClient.serviceKey);       this.apiConfig = serviceScope.consume(ApiConfigServiceKey); 		}); 	}  	public getAllBusinessDocuments(): Promise&lt;IBusinessDocument[]&gt; { 		return this.httpClient.get(this.apiConfig.apiUrl, HttpClient.configurations.v1, {       mode: 'cors',       credentials: 'include'     }).then((resp) =&gt; resp.json()); 	}  	public getMyBusinessDocuments(): Promise&lt;IBusinessDocument[]&gt; { 		return this.httpClient.get(this.apiConfig.apiMyDocumentsUrl, HttpClient.configurations.v1, {       mode: 'cors',       credentials: 'include'     }).then((resp) =&gt; resp.json()); 	}  	public getBusinessDocument(id: number): Promise&lt;IBusinessDocument&gt; { 		return this.httpClient.get(`${this.apiConfig.apiUrl}/${id}`, HttpClient.configurations.v1,{       mode: 'cors',       credentials: 'include'     }).then((resp) =&gt; resp.json()); 	}  	public createBusinessDocument(businessDocument: IBusinessDocument): Promise&lt;any&gt; { 		return this.httpClient 			.post(`${this.apiConfig.apiUrl}`, HttpClient.configurations.v1, {         body: JSON.stringify(businessDocument),         headers: [           ['Content-Type','application/json']         ], 				mode: 'cors', 				credentials: 'include' 			}) 			.then((resp) =&gt; resp.json()); 	}  	public updateBusinessDocument(id: number, update: IBusinessDocument): Promise&lt;any&gt; { 		return this.httpClient 			.fetch(`${this.apiConfig.apiUrl}/${id}`, HttpClient.configurations.v1, {         body: JSON.stringify(update),         headers: [           ['Content-Type','application/json']         ], 				mode: 'cors', 				credentials: 'include', 				method: 'PUT' 			}); 	}  	public removeBusinessDocument(id: number): Promise&lt;any&gt; { 		return this.httpClient 			.fetch(`${this.apiConfig.apiUrl}/${id}`, HttpClient.configurations.v1, { 				mode: 'cors',         credentials: 'include',         method:'DELETE' 			}); 	} }  export const BusinessDocumentsServiceKey = ServiceKey.create&lt;IBusinessDocumentsService&gt;( 	'ypcode:bizdocs-service', 	BusinessDocumentsService );\n</code> and let's create our main React component for our WebPart <a href="https://gist.github.com/ypcode/90545dc7a3d30ebc6a90547da8bfc17f">https://gist.github.com/ypcode/90545dc7a3d30ebc6a90547da8bfc17f</a> The most important parts in this code are the following :</p>
<ul>
<li>The hidden IFrame in the <strong><em>render()</em></strong> method, it will reach the default page of the add-in to initiate the context on the server-side <strong><em>&lt;iframe</em></strong> <strong><em>src=</em></strong> <strong><em>style={ { display: 'none' }}</em></strong> <strong><em>onLoad={() =&gt; (this.authenticated = true)}</em></strong> <strong><em>/&gt;</em></strong></li>
<li>The <strong>_<em>executeOrDelayUntilAuthenticated</em></strong>() method that will execute the function as argument only after the IFrame content is loaded. This will make sure the the Web API calls are done only after the user is properly authenticated.</li>
</ul>
<p>Another service class is used as the configuration holder and will take and compute its values from the WebPart properties. <img src="/images/2017/12/webpart-properties.png" alt="webpart-properties" /></p>
<ul>
<li><p>_<strong>remoteApiHost</strong> _: must contains the base URL of the provider hosted add-in (In this case, I use the address of my IIS Express instance launched by Visual Studio)</p>
</li>
<li><p>_<strong>appInstanceId</strong> _: must contains the GUID of the add-in instance. This GUID is found as the value of the query string parameter of the <strong><em>appredirect.aspx</em></strong> page when you click your add-in icon in SharePoint.</p>
</li>
</ul>
<p>  The App Instance ID can also be easily found using PnP PowerShell, just use the following PowerShell cmdlet:</p>
<blockquote>
<p><em><strong>Get-PnPAppInstance -Identity &quot;your app name&quot;</strong></em></p>
</blockquote>
<p><img src="/images/2017/12/ps-appinstanceid.png" alt="ps-appinstanceid" /> Just copy/paste the Id as the value of the &quot;App Instance ID&quot; WebPart property You will find the whole SPFx solution in the <a href="https://github.com/ypcode/spfx-webapi-spaddin/tree/master/spfx-webapi-client">GitHub repo</a></p>
<h1 id="result">Result</h1>
<p>[gallery ids=&quot;5230,5231,5232&quot; type=&quot;slideshow&quot;] We have now a custom WebPart able to interact with SharePoint data via our custom Web API. In this API we can implement any business logic, use App-Only mode or stick to the User permissions context. This solution is usable on SharePoint Online as well as on SharePoint On-prem ! Now that I have this boilerplate and PoC running, I think it will become my favorite approach when I need to build a customization that needs server-side custom code :) Leave your comments and feedback and please share this blog around you ! I wish you all the best for the upcoming new year and you can expect plenty other blog posts in 2018 ! Best regards, Yannick</p>

    </div>
</div>
        </main>

        <footer class="border-top footer">
                &copy; Copyrights 2020 - YPcode - Yannick Plenevaux
        </footer>
    </div>


    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/site.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js" ></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.js" ></script>

        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-aspnet.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-c.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-clike.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-csharp.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-css-extras.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-scss.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-markup.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-javascript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-jsx.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-powershell.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-typescript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.js" ></script>



</body>
</html>
