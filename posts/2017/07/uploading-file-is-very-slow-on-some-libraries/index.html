<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>YPcode</title>
    <link rel="icon" href="/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://ypcode.github.io/posts/2017/07/uploading-file-is-very-slow-on-some-libraries" />
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <meta name="generator" content="PVX WebContentGenerator" />
   
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css">
</noscript>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372458-1');
</script>

<style>
.social-links {
    display: inline-flex;
    width: 60%;
    margin:auto;
    justify-content: center;
    color: #807070;
}

.social-links a {
    margin-right: 15px;
}

.social-links a:hover {
    color: #9e1e28;
}

    .social-links svg {
        fill: currentColor;
        height: 18px;
    }
</style>
        <meta property="og:site_name" content="YPcode" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="Uploading file is very slow on some libraries" />
        <meta property="og:url" content="https://ypcode.github.io/posts/2017/07/uploading-file-is-very-slow-on-some-libraries" />
        <meta property="og:image" content="https://ypcode.github.io/images/code.jpg" />
        <meta property="article:publisher" content="https://www.facebook.com/yannick.plenevaux" />
        <meta property="article:published_time" content="2017-07-31 05:15:59Z" />
        <meta property="article:modified_time" content="2017-07-31 05:15:59Z" />
                <meta property="article:tag" content="Content Type" />
                <meta property="article:tag" content="Document Library" />
                <meta property="article:tag" content="Document Set" />
                <meta property="article:tag" content="Event Receiver" />
                <meta property="article:tag" content="Performance" />
                <meta property="article:tag" content="SharePoint" />
                <meta property="article:tag" content="SharePoint Online" />
                <meta property="article:tag" content="Upload" />
        <meta name="twitter:title" content="Uploading file is very slow on some libraries" />
        <meta name="twitter:url" content="https://ypcode.github.io/posts/2017/07/uploading-file-is-very-slow-on-some-libraries" />
            <meta name="twitter:card" content="summary_large_image" />
            <meta name="twitter:image" content="https://ypcode.github.io/images/code.jpg" />
            <meta name="twitter:label2" content="Filed under" />
            <meta name="twitter:data2" content="Content Type, Document Library, Document Set, Event Receiver, Performance, SharePoint, SharePoint Online, Upload" />
        <meta name="twitter:site" content="@yp_code" />
    <link rel="alternate" type="application/rss+xml" title="YPcode" href="https://ypcode.github.io/feed" />


    <script>
        var initialSiteContentHeight = null;
        function toggleMenu() {
            var menu = document.querySelector(".menu");
            var siteContent = document.querySelector(".site-content");
            if (menu && siteContent) {
                if (menu.classList.contains("visible")) {
                    menu.classList.remove("visible");
                } else {
                    menu.classList.add("visible");
                }
            }
        }
    </script>
</head>
<body>
    <div class="menu">
        <span class="menu-hamburger-icon" onclick="toggleMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" 
                x="0px" 
                y="0px"
                width="30" 
                height="30"
                viewBox="0 0 172 172"
                style=" fill:#000000;">
                    <g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M0,25.8v17.2h172v-17.2zM0,77.4v17.2h172v-17.2zM0,129v17.2h172v-17.2z"></path></g></g>
            </svg>
        </span>
        <a href="https://ypcode.github.io/">
            <h1 class="main-site-title">YPcode</h1>
            <hr class="sep main-site-title-sep"/>
            <h2 class="main-site-description">Experiences and research on Microsoft 365, Azure and modern web development</h2>
        </a>
        <nav class="navigation">
    <ul>
<li class="nav-item">
    <span class="link-icon icon-home" ></span><a class="nav-link" href="/" >Home</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/about-me/" >About me</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/projects-contrib/" >Projects &amp; Contributions</a>
</li>    </ul>
</nav>
        
            <div class="main-site-author">
                    <img class="main-site-author-picture" src="/images/me.png" />
                    <h3 class="main-site-author-name">
                        Yannick Plenevaux
                    </h3>
                        <h3 class="main-site-author-description">
                                <span class="main-site-author-description-line">Microsoft 365 Solutions Architect</span>
                                <span class="main-site-author-description-line">Office Development MVP</span>
                        </h3>
            </div>

        <div class="menu-social-links">
            <p class="social-links">

    <a href="https://mvp.microsoft.com/en-us/PublicProfile/5003599?fullName=Yannick%20Plenevaux" target="_blank"
        title="Microsoft MVP" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
            <defs>
                <style>
                    .a {
                        fill: currentColor;
                    }

                    .b {
                        fill: #1d1d1d;
                    }
                </style>
            </defs>
            <rect class="a" width="50" height="50"></rect>
            <path class="b"
                d="M17.42,26.16a15.14,15.14,0,0,0-.22,1.59l-.07.48h0a14.16,14.16,0,0,0-.33-2l-1.82-7.89h-3.5v13h2.07V24.43c0-1.18,0-2.39-.09-3.61h.08l.35,2.3,2,8.19h2.28L20,23c.18-.9.31-1.63.39-2.18h.05q-.09,2-.09,2.94v7.55h2.14v-13H19.13Zm18.36.72h1a3.81,3.81,0,0,0,3-1.24,4.54,4.54,0,0,0,1.14-3.17,4.23,4.23,0,0,0-1-3.08A3.81,3.81,0,0,0,37,18.34H33.29v13h2.49Zm0-6.37h.83a1.62,1.62,0,0,1,1.25.52,2.25,2.25,0,0,1,.48,1.57c0,1.42-.57,2.13-1.7,2.13h-.86Zm-9.24,10.8h2.67l3.31-13H30l-1.8,8.5c-.09.47-.15.92-.19,1.34l-.05.35h-.06a12,12,0,0,0-.2-1.65l-1.8-8.54H23.32ZM25.26,46.75,3.75,25.24,25.24,3.75,46.75,25.26Z"
                transform="translate(-0.25 -0.25)"></path>
        </svg>
        </a>

    <a href="https://twitter.com/yp_code" target="_blank" title="Twitter" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
            </path>
        </svg>
    </a>

    <a href="https://github.com/ypcode" target="_blank" title="GitHub" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path
                d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
            </path>
        </svg>
    </a>

    <a href="https://www.linkedin.com/in/yannickplenevaux" target="_blank" title="LinkedIn" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
                d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z">
            </path>
        </svg>
    </a>


</p>
        </div>
    </div>
   
    <div class="site-content">
        <main role="main" class="pb-3">
            <div class="content-item post">
    
    <div class="content-item-title">
        <span class="post-publishing-date">Jul 31, 2017</span>
        <h1>
            Uploading file is very slow on some libraries
            <hr/>
        </h1>
    </div>

        <div class="content-item-featured-image-container">
            <img class="content-item-featured-image" src="https://ypcode.github.io/images/code.jpg" alt="code image" />
        </div>
   
    <div class="content">
        <p>Hello everyone, <img src="/images/2017/07/upload_document-512.png" alt="Upload_Document-512" />Today we will talk about a problem that can arise when uploading documents in a library =&gt; slowness! When I say &quot;we&quot;, I mean my colleague Christopher Clement and myself. Having faced this problem together, we figured we would write together about it!</p>
<h2 id="context"><strong>Context</strong></h2>
<p>In the case we studied, the upload of a document in an empty library took 200ms whereas the same document in another library of the same site took 18 seconds! The differences between the two libraries Lib 1</p>
<ul>
<li>No documents</li>
<li>No content types added</li>
</ul>
<p>Lib 2</p>
<ul>
<li>32136 items</li>
<li>72 content types including 70 derived from the &quot;Document Set&quot; content type</li>
</ul>
<p>Wait, WHAT??!! 30000 items?? That’s the reason, it is poorly indexed, and so on, and so on... In fact, no, that wasn’t the cause of the issue, the indexing and structure were correct, so let's move on to the other difference, <strong>the number of content types</strong>. Actually, this library uses a significant number of content types inheriting from Document Set.</p>
<h2 id="document-set"><strong>Document Set</strong></h2>
<p><img src="/images/2017/07/documentseticon.png" alt="documentseticon" />As a reminder, a Document Set is a super folder that brings interesting features such as the configuration of a custom page and &quot;shared metadata&quot;. This second feature is the reason why Document Sets are used here, it allows to share or rather propagate its own metadata to all the documents that it contains. A feature that we had used several times on previous projects. The difference here is the large number of different content types.</p>
<h2 id="tests"><strong>Tests</strong></h2>
<p><strong>Note :</strong> If the problem we have encountered has occurred on an on-premise environment, you should know that we performed the tests on the on-premise AND on an Office 365 environment with the same results. Our test scenario was to upload a “test.txt” document containing only the word &quot;test&quot; in libraries with different configurations. On our production library, we have the following configuration: <img src="/images/2017/07/lib-config.png" alt="lib config" /></p>
<ul>
<li>2643 document sets</li>
<li>32136 items in total (including documents sets)</li>
<li>72 content types</li>
</ul>
<p>The upload on this library of our file &quot;test.txt&quot; takes between 5 and 20 seconds to respond, depending on the solicitation of the resources on the server. In our tests, the response time was 18 seconds. So we started by measuring the response time for the upload of the same document on a brand new library without any specific configuration. <img src="/images/2017/07/investigation-upload-speed-no-docset.png" alt="investigation-upload-speed-no-docset.png" /> The response time (0.87 seconds) is minimal compared to our production library. The next step was to gradually add content types (inheriting from Document Set) to measure the impact for different numbers of Content Types added. We're talking about the content types that are configured on the list, not the “documents sets” items added to the library. Here are the results: For <strong>1</strong> content type inheriting from <strong><em>Document Set</em></strong>: 312 ms<img src="/images/2017/07/investigation-upload-speed-1docset.png" alt="investigation-upload-speed-1docset.png" />For <strong>30</strong> content types inheriting from <strong><em>Document Set</em></strong>: 4.93s<img src="/images/2017/07/investigation-upload-speed-31docsets.png" alt="investigation-upload-speed-31docsets.png" />For <strong>50</strong> content types inheriting from <strong><em>Document Set</em></strong>: 11.18s<img src="/images/2017/07/investigation-upload-speed-51docsets.png" alt="investigation-upload-speed-51docsets" /> We clearly observe that the number of Document Set content types available in the list impacts the time required for the upload of a document.</p>
<h2 id="why"><strong>Why ?</strong></h2>
<p><img src="/images/2017/07/gear-sh.png" alt="Gear SH" />We have already noticed in the past that the functionality of a Document Set is provided by Event Receivers added to the list,  there are actually 4: ItemAdding, ItemAdded, ItemUpdating and ItemUpdated. So we checked on that side if that could be the reason. We were astonished at what we found out.<img src="/images/2017/07/dossiers_eventreceivers_count.png" alt="dossiers_eventreceivers_count" /> **283 Event Receivers are attached to the library **!<img src="/images/2017/07/list_eventreceivers.png" alt="list_eventreceivers.png" /></p>
<ul>
<li>283 Event Receivers (285 - 2 header lines)</li>
<li>They are <strong>ALL</strong> in Synchronous mode, even those in -ed which are not by default.</li>
</ul>
<p>We could have thought that Event Receivers would have been added once for all DocumentSet content types, but no! <strong>For each Content Type added, 4 Event Receivers are added to the list.</strong> Synchronous events receivers are executed before the response is returned to the client. In our case, at least 140 event receivers are executed each time an item is added, and another 140 are executed at each update. Moreover, if you ever had the opportunity to develop a custom (server side) event receiver, you might have realized that you configure it through its type (.NET Class) fully qualified name. That means, somehow, it is dynamically (and probably lazily) loaded. It must have its footprint has well on the performance. This explains the slowness.</p>
<h2 id="resolution"><strong>Resolution</strong></h2>
<p>Solving this problem can be done in 2 ways according to your needs</p>
<h3 id="reducing-the-number-of-content-types"><em>1 : Reducing the number of content types</em></h3>
<p>If the number of content types inheriting from &quot;Document Set&quot; may decrease, reduce it to the maximum, a unique &quot;Document Set&quot; content type would be ideal. Migrate your existing documents to this unique content type. If you need to migrate content types from existing documents, I invite you to read these posts which explain a way to do it: (<a href="https://ypcode.wordpress.com/2016/12/08/cross-sharepoint-platform-maintenance-tools-using-pnp-powershell/">https://ypcode.wordpress.com/2016/12/08/cross-sharepoint-platform-maintenance-tools-using-pnp-powershell/</a>) (<a href="https://ypcode.wordpress.com/2017/07/22/powershell-quicktip-3-characters-to-improve-a-script/">https://ypcode.wordpress.com/2017/07/22/powershell-quicktip-3-characters-to-improve-a-script/</a>) Then delete content types inheriting from &quot;Document Set&quot; that are no longer used in the library. This will remove related event receivers.</p>
<h3 id="division-of-the-structure-into-several-libraries"><em>2 : Division of the structure into several libraries</em></h3>
<p>If you need to keep several types of &quot;Document Set&quot; content type, we recommend that you divide the content between several libraries, each using one of your content types.</p>
<h3 id="resolution-bis-on-premise-only"><strong>Resolution bis (on-premise only)</strong></h3>
<p>We also noticed that the auto-increment of the database was set to 1 mega, we increased this size to reduce SQL work when uploading document. Hoping this helps! <a href="https://christopherclementen.wordpress.com/">Christopher</a> and Yannick</p>

    </div>
</div>
        </main>

        <footer class="border-top footer">
                &copy; Copyrights 2020 - YPcode - Yannick Plenevaux
        </footer>
    </div>


    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/site.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js" ></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.js" ></script>

        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-aspnet.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-c.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-clike.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-csharp.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-css-extras.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-scss.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-markup.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-javascript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-jsx.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-powershell.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-typescript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.js" ></script>



</body>
</html>
