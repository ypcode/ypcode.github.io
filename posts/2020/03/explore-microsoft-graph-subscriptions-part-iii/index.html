<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>YPcode</title>
    <link rel="icon" href="/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://ypcode.github.io/posts/2020/03/explore-microsoft-graph-subscriptions-part-iii" />
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
    <meta name="generator" content="PVX WebContentGenerator" />
   
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism-tomorrow.min.css">
</noscript>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.css">
</noscript>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372458-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372458-1');
</script>

<style>
.social-links {
    display: inline-flex;
    width: 60%;
    margin:auto;
    justify-content: center;
    color: #807070;
}

.social-links a {
    margin-right: 15px;
}

.social-links a:hover {
    color: #9e1e28;
}

    .social-links svg {
        fill: currentColor;
        height: 18px;
    }
</style>
        <meta property="og:site_name" content="YPcode" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="Explore Microsoft Graph Subscriptions – Part III: Handle subscription lifetime" />
        <meta property="og:url" content="https://ypcode.github.io/posts/2020/03/explore-microsoft-graph-subscriptions-part-iii" />
        <meta property="og:image" content="https://ypcode.github.io/images/msgraph-webhooks-partiii.png?r=202007151114" />
        <meta property="article:publisher" content="https://www.facebook.com/yannick.plenevaux" />
        <meta property="article:published_time" content="2020-03-09 06:30:22Z" />
        <meta property="article:modified_time" content="2020-03-09 06:30:22Z" />
                <meta property="article:tag" content="App Only" />
                <meta property="article:tag" content="App Permissions" />
                <meta property="article:tag" content="Azure" />
                <meta property="article:tag" content="Azure Functions" />
                <meta property="article:tag" content="Microsoft 365" />
                <meta property="article:tag" content="Microsoft Graph" />
                <meta property="article:tag" content="PnP" />
                <meta property="article:tag" content="Subscriptions" />
                <meta property="article:tag" content="TypeScript" />
                <meta property="article:tag" content="Webhook" />
        <meta name="twitter:title" content="Explore Microsoft Graph Subscriptions – Part III: Handle subscription lifetime" />
        <meta name="twitter:url" content="https://ypcode.github.io/posts/2020/03/explore-microsoft-graph-subscriptions-part-iii" />
            <meta name="twitter:card" content="summary_large_image" />
            <meta name="twitter:image" content="https://ypcode.github.io/images/msgraph-webhooks-partiii.png?r=202007151114" />
            <meta name="twitter:label2" content="Filed under" />
            <meta name="twitter:data2" content="App Only, App Permissions, Azure, Azure Functions, Microsoft 365, Microsoft Graph, PnP, Subscriptions, TypeScript, Webhook" />
        <meta name="twitter:site" content="@yp_code" />
    <link rel="alternate" type="application/rss+xml" title="YPcode" href="https://ypcode.github.io/feed" />


    <script>
        var initialSiteContentHeight = null;
        function toggleMenu() {
            var menu = document.querySelector(".menu");
            var siteContent = document.querySelector(".site-content");
            if (menu && siteContent) {
                if (menu.classList.contains("visible")) {
                    menu.classList.remove("visible");
                } else {
                    menu.classList.add("visible");
                }
            }
        }
    </script>
</head>
<body>
    <div class="menu">
        <span class="menu-hamburger-icon" onclick="toggleMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" 
                x="0px" 
                y="0px"
                width="30" 
                height="30"
                viewBox="0 0 172 172"
                style=" fill:#000000;">
                    <g fill="none" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><path d="M0,172v-172h172v172z" fill="none"></path><g fill="#ffffff"><path d="M0,25.8v17.2h172v-17.2zM0,77.4v17.2h172v-17.2zM0,129v17.2h172v-17.2z"></path></g></g>
            </svg>
        </span>
        <a href="https://ypcode.github.io/">
            <h1 class="main-site-title">YPcode</h1>
            <hr class="sep main-site-title-sep"/>
            <h2 class="main-site-description">Experiences and research on Microsoft 365, Azure and modern web development</h2>
        </a>
        <nav class="navigation">
    <ul>
<li class="nav-item">
    <span class="link-icon icon-home" ></span><a class="nav-link" href="/" >Home</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/about-me/" >About me</a>
</li><li class="nav-item">
    <span class="link-icon icon-about" ></span><a class="nav-link" href="/pages/projects-contrib/" >Projects &amp; Contributions</a>
</li>    </ul>
</nav>
        
            <div class="main-site-author">
                    <img class="main-site-author-picture" src="/images/me.png" />
                    <h3 class="main-site-author-name">
                        Yannick Plenevaux
                    </h3>
                        <h3 class="main-site-author-description">
                                <span class="main-site-author-description-line">Microsoft 365 Solutions Architect</span>
                                <span class="main-site-author-description-line">Office Development MVP</span>
                        </h3>
            </div>

        <div class="menu-social-links">
            <p class="social-links">

    <a href="https://mvp.microsoft.com/en-us/PublicProfile/5003599?fullName=Yannick%20Plenevaux" target="_blank"
        title="Microsoft MVP" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
            <defs>
                <style>
                    .a {
                        fill: currentColor;
                    }

                    .b {
                        fill: #1d1d1d;
                    }
                </style>
            </defs>
            <rect class="a" width="50" height="50"></rect>
            <path class="b"
                d="M17.42,26.16a15.14,15.14,0,0,0-.22,1.59l-.07.48h0a14.16,14.16,0,0,0-.33-2l-1.82-7.89h-3.5v13h2.07V24.43c0-1.18,0-2.39-.09-3.61h.08l.35,2.3,2,8.19h2.28L20,23c.18-.9.31-1.63.39-2.18h.05q-.09,2-.09,2.94v7.55h2.14v-13H19.13Zm18.36.72h1a3.81,3.81,0,0,0,3-1.24,4.54,4.54,0,0,0,1.14-3.17,4.23,4.23,0,0,0-1-3.08A3.81,3.81,0,0,0,37,18.34H33.29v13h2.49Zm0-6.37h.83a1.62,1.62,0,0,1,1.25.52,2.25,2.25,0,0,1,.48,1.57c0,1.42-.57,2.13-1.7,2.13h-.86Zm-9.24,10.8h2.67l3.31-13H30l-1.8,8.5c-.09.47-.15.92-.19,1.34l-.05.35h-.06a12,12,0,0,0-.2-1.65l-1.8-8.54H23.32ZM25.26,46.75,3.75,25.24,25.24,3.75,46.75,25.26Z"
                transform="translate(-0.25 -0.25)"></path>
        </svg>
        </a>

    <a href="https://twitter.com/yp_code" target="_blank" title="Twitter" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path
                d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
            </path>
        </svg>
    </a>

    <a href="https://github.com/ypcode" target="_blank" title="GitHub" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path
                d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
            </path>
        </svg>
    </a>

    <a href="https://www.linkedin.com/in/yannickplenevaux" target="_blank" title="LinkedIn" rel="noopener">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
            <path
                d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z">
            </path>
        </svg>
    </a>


</p>
        </div>
    </div>
   
    <div class="site-content">
        <main role="main" class="pb-3">
            <div class="content-item post">
    
    <div class="content-item-title">
        <span class="post-publishing-date">Mar 09, 2020</span>
        <h1>
            Explore Microsoft Graph Subscriptions – Part III: Handle subscription lifetime
            <hr/>
        </h1>
    </div>

        <div class="content-item-featured-image-container">
            <img class="content-item-featured-image" src="https://ypcode.github.io/images/msgraph-webhooks-partiii.png?r=202007151114" alt="code image" />
        </div>
   
    <div class="content">
        <p>Hi Microsoft 365 devs !
Here we go again with the part III of my blog post series about Microsoft Graph Subscriptions (aka Webhooks).
In this post, we will see how we can implement a real world solution that handles the lifetime of our Microsoft Graph subscriptions !</p>
<h2 id="whats-the-matter-with-subscription-lifetime">What's the matter with subscription lifetime ?</h2>
<p>Microsoft Graph subscriptions are great to hook our custom logic triggered by the events that occur in our corporate information (groups, users, events, and so on...).
However, as we have seen in part I &amp; II of this series, the subscriptions we create expire after quite a small amount of time.
This expiration allows Microsoft Graph to spare execution cycles that may, in fact, be totally useless since the remote system may no longer use them!
So, as long as we want our custom solution to handle properly the notifications and keep receiving them, we need to implement some logic that will allow us to do so...
It requires a bit of a significant effort to achieve something that might seem trivial, but it is probably also a way to ensure that, we, third parties, are not overwhelming Microsoft Graph without caring what we do without a very good reason to do it.</p>
<h2 id="lets-architect-a-viable-solution">Let's architect a viable solution !</h2>
<p>In the previous part, we saw how to implement our Webhook as a pro with Azure Functions using TypeScript and VS Code.
We will rely on these foundations to make sure that the lifetime of our subscription are properly extended anytime it is needed.
Concretely, it means that, whenever a notification is sent to our system, the Webhook will not only trigger our custom business logic to be executed, but will also update the subscription to postpone the date of its expiration.
In order to respond as fast as possible to Graph (as expected from Webhook endpoints), we will delegate the tasks to other functions that gets executed when a message is pushed into a queue.
Let's see how the code of our Webhook will look like</p>
<p><code>\nimport { AzureFunction, Context, HttpRequest } from &quot;@azure/functions&quot; import { INotificationsPayload } from &quot;../entities/INotification&quot;;  import { SUBSCRIPTIONS_QUEUE_NAME, BUSINESS_TASKS_QUEUE_NAME } from &quot;../helpers/configure&quot;; import { addMessageToQueue } from &quot;../helpers/azure-queue-helper&quot;;  const httpTrigger: AzureFunction = async function (context: Context, req: HttpRequest): Promise&lt;void&gt; {     context.log('HTTP trigger function processed a request.');     // Validate the subscription creation     if (req.query.validationToken) {         context.log('Validating new subscription...');         context.log('Validation token:');         context.log(req.query.validationToken);         context.res = {             headers: {                 'Content-Type': 'text/plain'             },             body: req.query.validationToken         };     }     else {         context.log('Received new notification from Microsoft Graph...');         context.log('Notifications: ');         const payload = req.body as INotificationsPayload;         payload.value.forEach(async (n, i) =&gt; {             context.log(` Notification #${i} `);             context.log(`----------------------------------------------------------`);             context.log(`Subscription Id    : ${n.subscriptionId}`);             context.log(`Expiration         : ${n.subscriptionExpirationDateTime}`);             context.log(`Change Type        : ${n.changeType}`);             context.log(`Client State       : ${n.clientState}`);             context.log(`Resource           : ${n.resource}`);             const resourceData = n.resourceData &amp;&amp; JSON.stringify(n.resourceData);             context.log(`Resource Data      : ${resourceData}`);             context.log(`----------------------------------------------------------`);              // ====================================================================================             // HERE we delegate the business logic work to a dedicated queue triggered function             // We pass any needed parameter that might come from the notification             // ====================================================================================             try {                 const taskArgs = {                     eventId: n.resource                 };                 await addMessageToQueue(BUSINESS_TASKS_QUEUE_NAME, JSON.stringify(taskArgs));             }             catch (err) {                 context.log.error(err);             }              // ====================================================================================              // ====================================================================================             // HERE Ensure the subscription lifetime will be extended             // ====================================================================================             // we push the subscription id to the subscriptions queue             // The EnsureSubscription queue-triggered function              // will in turn update the expiration of the subscription if needed             try {                 await addMessageToQueue(SUBSCRIPTIONS_QUEUE_NAME, n.subscriptionId);             }             catch (err) {                 context.log.error(err);             }         });          context.res = { body: &quot;&quot; };     } };  export default httpTrigger;\n</code></p>
<p>As we can see at line 60, we push the subscription id to a queue, an other Azure Function we call <strong><em>EnsureSubscription</em></strong> will be triggered and will be responsible for updating the expiration date of the subscription.
Another queue-triggered Function we call <strong>BusinessTask</strong> will achieve what we really want to do with the notification.</p>
<h3 id="setup-some-prerequisites">Setup some prerequisites</h3>
<ul>
<li>It will use Microsoft Graph to update the subscription expiration.
Thus, it needs to be allowed to. It will do it in an unattended manner.
If you follow me, it means we need to register an AAD application and grant it the needed application permissions</li>
<li>To implement the calls to Microsoft Graph in the easiest possible way, I will use the awesome PnP JS library (however, that is not strictly required)!</li>
</ul>
<h4 id="register-the-aad-application">Register the AAD application</h4>
<p>From the Azure AD portal, go to the App registrations section and click <strong>Add new registration</strong>
<img src="/images/2020/02/azuread-appregistration.png" alt="AzureAD-AppRegistration" /></p>
<p>Select a name and register the new application. We'll need to grant our application the required permissions, From the <strong>API Permissions</strong> section, add the following permissions to Microsoft Graph, don't forget to grant admin consent once you set the API permissions <img src="/images/2020/03/azuread-appregistration-appperms-1.png" alt="AzureAD-AppRegistration-appPerms" /></p>
<p>We will put the needed AAD app information in our function app settings. At development time, it will be in the <strong>local.settings.json</strong> file that should probably already exist in your solution. If it does not, you can create it with the keys we'll set the values later on</p>
<p><code>\n{   &quot;IsEncrypted&quot;: false,   &quot;Values&quot;: {     &quot;TENANT&quot;: &quot;&quot;,     &quot;AAD_APP_ID&quot;: &quot;&quot;,     &quot;AAD_APP_SECRET&quot;: &quot;&quot;,     &quot;OVERRIDDEN_WEBSITE_HOSTNAME&quot;: &quot;&quot;,     &quot;SUBSCRIBED_RESOURCE_URI&quot; : &quot;&quot;,     &quot;FUNCTIONS_WORKER_RUNTIME&quot;: &quot;node&quot;,     &quot;AZURE_STORAGE_CONNECTION_STRING&quot;: &quot;&quot;,     &quot;AzureWebJobsStorage&quot;: &quot;&quot;   } }\n</code></p>
<p>From the</p>
<ul>
<li>Copy the <strong>Directory (tenant) Id</strong> and paste it as the value of the <strong>TENANT</strong> app setting</li>
<li>Copy the <strong>Application (client) Id</strong> and paste it as the value of the <strong>AAD_APP_ID</strong> app setting</li>
</ul>
<p><img src="/images/2020/03/azuread-appregistration-ids.png" alt="AzureAD-AppRegistration-Ids" /></p>
<p>Since our Azure Function will use Microsoft Graph in an unattended manner (without any user interaction), We will use client credentials authentication flow, we then need to generate a client secret.</p>
<p><img src="/images/2020/03/azuread-appregistration-appsecret.png" alt="AzureAD-AppRegistration-AppSecret" /></p>
<p>From the <strong>Certificates &amp; secret</strong> section, click the <strong>New client secret</strong> button to generate a new one, copy the generated secret as the value of the key <strong>AAD_APP_SECRET</strong> in your app settings. Make sure to copy it immediately, because you will never be able to see it again. <strong>Note</strong>: I'll use a client secret it to avoid bring more complexity to the steps here. It is actually recommended that you rather use client certificates instead which are safer.</p>
<h4 id="install-the-dependencies">Install the dependencies</h4>
<p>As mentioned above, we will use PnP JS, we will also need to use the Azure Storage API. In a console in your solution folder, type the following command</p>
<blockquote>
<p>npm install @pnp/graph-commonjs @pnp/logging @pnp/nodejs-commonjs azure-storage --save</p>
</blockquote>
<h4 id="tip-for-development-time">Tip for development time</h4>
<p>Since we are now doing much more development, it will probably be easier to run our azure function locally, it will be much easier to debug ! <strong>But</strong> As you probably understood by now, Microsoft Graph subscriptions need to access a public URI. That's most likely not the case of our development web server. We will use <em><strong>ngrok</strong></em> to redirect a public facing URL to our local development machine.
We'll need to <a href="https://ngrok.com/">download the small tool</a>. Run the tool as such</p>
<blockquote>
<p><strong><em>ngrok http 7071</em></strong></p>
</blockquote>
<p>Note that 7071 is the http port used by the development Azure Function runtime, you'll probably have to make sure it is the same port used in your local runtime, but it is most likely the case ! We will then need to copy the ngrok public URL to our app settings
<img src="/images/2020/03/ngrok_https_url.png" alt="ngrok_https_url" />
Copy the https URL as the value of <strong>OVERRIDDEN_WEBSITE_HOSTNAME</strong> app setting.</p>
<h4 id="configure-the-microsoft-graph-resource-to-subscribe-to">Configure the Microsoft Graph Resource to subscribe to</h4>
<p>In the app settings, we'll also need to specify the resource we want to subscribe to, concretely, it means set the Microsoft Graph relative URL of the resource. For instance, here I will subscribe to the events of my user, I will need to specify it using the user id like &quot;<strong>users/efda010b-19a4-4303-bf7b-70bd6e62e7d2/events</strong>&quot;, since we will use Microsoft Graph using an app-only token, we cannot use &quot;<strong>me/events</strong>&quot;</p>
<h4 id="lets-create-a-few-helpers">Let's create a few helpers</h4>
<p>In a <strong>helpers</strong> folder: create a <strong><em>configure.ts</em></strong> with the following code</p>
<pre><code class="language-\nimport" graph="">
create a file **_date-helper.ts_** 

```\nexport const DEFAULT_SAFETY_WINDOW_IN_MSECS = 4860000; // 1h31 (Graph common delay is 4230 rounded minutes (70.5 h))  export const getExpirationDateTimeISOString = (fromNowInDays: number, safetyWindowInMsecs?: number) =&gt; {     const now = Date.now();     //                                day     24h 60m  60s   ms           // const expiration = now + (fronNowInDays * 24 * 60 * 60 * 1000);     const expiration = now + (fromNowInDays * 86400000) - (safetyWindowInMsecs || DEFAULT_SAFETY_WINDOW_IN_MSECS);     return new Date(expiration).toISOString(); };   export const isNearlyExpired = (dateIsoString: string, safetyWindowInMsecs?: number) =&gt; {     const date = Date.parse(dateIsoString);     return (date - (safetyWindowInMsecs || DEFAULT_SAFETY_WINDOW_IN_MSECS)) &lt;= Date.now(); }\n``` 

create a file **_azure-queue-helper.ts_** 

```\nimport * as azure from &quot;azure-storage&quot;;  let _queueService = null; const getQueueService = () =&gt; {     if (!_queueService) {         _queueService = azure.createQueueService();     }     return _queueService; }  export const addMessageToQueue = async (queue: string, message: string): Promise&lt;void&gt; =&gt; {      return new Promise((resolve, reject) =&gt; {         const queueService = getQueueService();         queueService.createQueueIfNotExists(queue, (error, results, response) =&gt; {             if (!error) {                 const base64EncodedMessage = new Buffer(message).toString(&quot;base64&quot;);                 queueService.createMessage(queue, base64EncodedMessage, (err, msgResult, msgResp) =&gt; {                     if (err) {                         reject(&quot;Could not send message to queue&quot;);                     }                      resolve();                 })             } else {                 reject(&quot;Queue could not be created.&quot;);             }         });     }); } \n``` 

create a file **_subscription-helpers.ts_** 

```\nimport { Logger } from &quot;@azure/functions&quot; import { graph } from &quot;@pnp/graph-commonjs&quot;; import { Subscription } from &quot;@microsoft/microsoft-graph-types&quot;;   const isValidForCreate = (subscription: Subscription) =&gt; {     return !!(subscription.changeType &amp;&amp; subscription.notificationUrl &amp;&amp; subscription.resource &amp;&amp; subscription.expirationDateTime); }  const isValidForUpdate = (subscription: Subscription) =&gt; {     return !!(subscription.id &amp;&amp; subscription.expirationDateTime); }  export const getSubscription = async function (subscriptionId: string, log: Logger): Promise&lt;Subscription&gt; {     try {         const subscription = await graph.subscriptions.getById(subscriptionId).get();         return subscription;     } catch (error) {         log.warn(`An error occured while trying to get subscription with Id ${subscriptionId}`, error);         return null;     } }  export const createSubscription = async function (subscription: Subscription, log: Logger): Promise&lt;Subscription&gt; {     if (isValidForCreate(subscription)) {         log(&quot;Creating new subscription...&quot;);         const { changeType, notificationUrl, resource, expirationDateTime } = subscription;         const result = await graph.subscriptions.add(changeType, notificationUrl, resource, expirationDateTime, subscription);         log(`New subscription to ${changeType} of ${resource} has been created.`);         return result.data;     }     else {         log.error(&quot;Received request is not valid to create a subscription...&quot;);     } }  export const updateSubscription = async function (subscription: Subscription, log: Logger): Promise&lt;void&gt; {     if (isValidForUpdate(subscription)) {         log(`Updating subscription ${subscription.id}...`);         await graph.subscriptions.getById(subscription.id).update(subscription);         log(`Subscription ${subscription.id} has been updated.`);     } else {         log.error(&quot;Received request is not valid to update the subscription...&quot;);     } };\n``` 

and a last one **_subscription-setup.ts_** 

```\nimport { Logger } from &quot;@azure/functions&quot;; import { createSubscription } from &quot;./subscriptions-helper&quot;; import { getExpirationDateTimeISOString } from &quot;./date-helper&quot;; import { SETUP_RESOURCE, SETUP_CHANGE_TYPE, SETUP_NOTIFICATION_URL } from &quot;./configure&quot;;  export const setupNewSubscription = async function(log: Logger) {     log(&quot;Let's create a new subscription...&quot;);     const created = await createSubscription({         resource: SETUP_RESOURCE,         changeType: SETUP_CHANGE_TYPE,         notificationUrl: SETUP_NOTIFICATION_URL,         expirationDateTime: getExpirationDateTimeISOString(3)     }, log);      log(`A new subscription has been created with id ${created.id}`);     log(&quot;Please update the configuration accordingly...&quot;); }\n```

### Let's code the EnsureSubscription function

![Azure-Function-VSCode-CreateNew](/images/2020/03/azure-function-vscode-createnew.png)

First of all, let's create a new queue-triggered function, from VS Code Azure extension, click the &quot;Create function&quot; button. Select &quot;**_Azure Queue Storage Triggered_**&quot; and name it &quot;**_EnsureSubscription_**&quot;. Select the app setting you want to use to store the Azure Storage connection string. You will have to put the connection string to your storage account. The VS Code extensions also allows to create a new storage account if you don't already have one. Name the azure queue as &quot;**_subscriptions-to-ensure_**&quot; Then let's write the following code as the body of our EnsureSubscription function 

```\nimport { AzureFunction, Context } from &quot;@azure/functions&quot; import { isNearlyExpired, getExpirationDateTimeISOString } from &quot;../helpers/date-helper&quot;; import { updateSubscription, getSubscription } from &quot;../helpers/subscriptions-helper&quot;; import { setupNewSubscription } from &quot;../helpers/subscription-setup&quot;; import { configure, SETUP_EXPIRATION_DELAY_IN_DAYS } from &quot;../helpers/configure&quot;;  const queueTriggeredEnsureSubscription: AzureFunction = async function (context: Context, subscriptionId: string): Promise&lt;void&gt; {     context.log(`Ensuring subscription ${subscriptionId}...`);     configure(context);      const foundSubscription = await getSubscription(subscriptionId, context.log);     if (foundSubscription) {         context.log(&quot;A subscription has been found !&quot;);         context.log(`Resource    : ${foundSubscription.resource}`);         context.log(`Change type : ${foundSubscription.changeType}`);         context.log(`Expires on  : ${foundSubscription.expirationDateTime}`);          // At this point, if we realize the subscription is expiring soon, we update it with a new maximum delay starting right now !         if (isNearlyExpired(foundSubscription.expirationDateTime)) {             const expirationDateTime = getExpirationDateTimeISOString(SETUP_EXPIRATION_DELAY_IN_DAYS);             context.log(`Will update the expiration to ${expirationDateTime}`);             await updateSubscription({                 id: foundSubscription.id,                 expirationDateTime             },                 context.log);             context.log(&quot;Subscription updated.&quot;);         } else {             context.log(&quot;The subscription will not expire soon...&quot;);         }     } else {         context.log(`No subscription has been found with id ${subscriptionId}...`);         // If subscription is not found, it might have been deleted in the meantime for some reason         // In order to keep the whole system stable, we recreate a new subscription here         await setupNewSubscription(context.log);     } };  export default queueTriggeredEnsureSubscription;\n```

### Let's code the Business Task function

We will create another queue-triggered Azure Function that will execute the actual task we want to achieve whenever a notification is received. Here my business task will be to simply log the Id of the updated event. It is here that you will have to change to code to achieve the task according to your requirements. Repeat the steps above to create a new queue-triggered Function and name the queue **_&quot;business-tasks&quot;_**. Just for information, the code I have in this function is 

```\nimport { AzureFunction, Context } from &quot;@azure/functions&quot;; import { IBusinessTaskArgs } from &quot;../entities/IBusinessTaskArgs&quot;; import { GraphHttpClient } from &quot;@pnp/graph-commonjs/graphhttpclient&quot;; import { configure } from &quot;../helpers/configure&quot;;  const queueTrigger: AzureFunction = async function (context: Context, taskArgs: IBusinessTaskArgs): Promise&lt;void&gt; {   // The calendar event is post process by our custom logic   context.log(`Received arguments: ${JSON.stringify(taskArgs)}`);   configure(context);    try {     // TODO Here implement custom logic     // e.g. Update the updated event's title     const resourceAbsoluteUrl = `https://graph.microsoft.com/v1.0/${taskArgs.eventResourceUri}`;     const client = new GraphHttpClient();     const eventResponse = await client.get(resourceAbsoluteUrl);     const event: { subject: string; } = await eventResponse.json();      // If event is not already processed     // Since we are updating the notified updated event, we have to check the custom task is not already done     // Otherwise, a notification will be resent and cause an &quot;infinite&quot; loop     if (event.subject.indexOf(&quot;[UPDATED]&quot;) != 0) {       const eventUpdate = {         subject: `[UPDATED] ${event.subject}`       }        const patchResponse = await client.patch(resourceAbsoluteUrl, {         body: JSON.stringify(eventUpdate)       });        if (patchResponse.ok) {         console.log(&quot;Event has been updated.&quot;);       } else {         console.log(&quot;Event could not be updated&quot;);       }     }   }   catch (error) {     context.log.error(&quot;An error occured while processing custom business task&quot;, error);   }  };  export default queueTrigger;\n``` 

This custom task will grab the updated event and update its subject if it is not already properly updated (This will avoid resulting in an infinite loop!).

### Let's test it

We should be good now, hit F5 in VS Code to run your Azure Function locally ! We will then need to trigger the subscription to be created ! To make sure all is going well, set a breakpoint in the EnsureSubscription index.ts file **at line 32** From the Azure Portal, access your storage account, select the **subscriptions-to-ensure** queue and add a new message with any dummy content 

![Azure-Storage-Queue](/images/2020/03/azure-storage-queue.png)
![Azure-Storage-Queue-AddMessage](/images/2020/03/azure-storage-queue-addmessage.png) 

Your breakpoint should be hit almost at once. Continue the execution and your subscription should be added. To test your webhook solution, set a breakpoint in your BusinessTask function and then add an event to the calendar of the user you specified (or do any action that should triggered the specific notification you requested). In my case, I create or update an event in my calendar (It is the resource monitored by the Microsoft Graph Subscription), and I see it gets updated after a few seconds

Now time to deploy !
--------------------

If everything in debug works as expected you can now deploy the Azure Function to Azure, in the VS Code extension tab, click the &quot;Deploy to Function App..&quot; button. Then you will have to make sure you copy the following app settings to the Function App

*   TENANT
*   AAD\_APP\_ID
*   AAD\_APP\_SECRET
*   SUBSCRIBED\_RESOURCE\_URI

Conclusion
----------

We now have a solution that will keep our subscriptions alive as long as it is used. Take care however, with this solution as is, if there is no activity during the maximum lifetime of your particular subscription, it will get deleted ! Fortunately, with the solution described in this post, the only thing you will have to do is to setup a time triggered function that will trigger the EnsureSubscription, But that will be part of a next post :) You can get the whole solution on the [GitHub repo here](https://github.com/ypcode/ypcode-msgraph-subscriptions) 

Hope you liked it and please let me know any feedback you might have ! 

Cheers ! 

Yannick
</code></pre>

    </div>
</div>
        </main>

        <footer class="border-top footer">
                &copy; Copyrights 2020 - YPcode - Yannick Plenevaux
        </footer>
    </div>


    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/site.js"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.min.js" ></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/autolinker/prism-autolinker.js" ></script>

        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-aspnet.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-c.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-clike.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-csharp.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-css-extras.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-scss.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-markup.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-javascript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-jsx.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-powershell.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-typescript.min.js" ></script>
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.js" ></script>



</body>
</html>
